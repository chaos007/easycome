<div class="modal-header" style="padding: 15px">
    <button type="button" class="close" data-dismiss="modal">
        <span aria-hidden="true" style="font-size: 30px;">&times;</span>
        <span class="sr-only">Close</span>
    </button>
    <h6 class="modal-title">新增品牌</h6>
</div>
<div class="modal-body">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>电梯厂家</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                <span class="input-required">*</span>厂家名称
                            </label>

                            <div class="col-sm-10">
                                <input type="text" id="w_brand" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">联系方式</label>
                            <div class="col-sm-10">
                                <input type="text" id="w_phone" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">地址</label>
                            <div class="col-sm-10">
                                <input type="text" id="w_address" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">联系人及信息</label>

                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="w_contact">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-title">
                    <h5>型号录入</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-inline">
                        <div class="form-group" >
                            <input type="text" class="form-control" id="w_brand_num" placeholder="请输入型号">
                        </div>
                        <button class="btn btn-primary" onclick="doAddBrandType()">新增型号</button>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title" style="padding-left: 0;">
                            <h5>型号列表</h5>
                        </div>
                        <div class="ibox-content">
                            <div class="dd" id="nestable">
                                <ol class="dd-list">
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-white" data-dismiss="modal">返回</button>
    <button type="button" class="btn btn-primary" onclick="saveBrandInfo()">确认</button>
</div>
<script>
    var brand_type_members = [];
    $(function () {
        app.win_action = 'add';
        if (app.win_url.indexOf("?key=") > 0) {
            app.win_action = 'edit';
            app.win_key = decodeURIComponent(app.win_url.split("?key=")[1]);
        }

        if (app.win_action == 'edit') {
            //编辑页面
            $(".modal-title").html("编辑品牌")
            //获取info
            var options = {
                url: 'FindManufacturerWithKey',
                data: {
                    ManufacturerName: app.win_key,
                },
                callback: initBrandInfo,
                callback_params: {}
            };

            app.execPostRequest(options);

        } 
    });

    function initBrandInfo(res, param) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            if (res.data == null) {
                return;
            }
            var info = res.data;
            $("#w_brand").val(info.Name);
            $("#w_brand").attr("disabled", "disabled");
            $("#w_phone").val(info.Phone);
            $("#w_address").val(info.Address);
            $("#w_contact").val(info.Contact);
            var contacts_list = res.data.ManufacturerTypeInfo;
            if (contacts_list != null && contacts_list.length > 0) {
                contacts_list.forEach(function (value, index, arr) {
                    addBrandTypeList(value ,{})
                });
            }
        }
    }

    function saveBrandInfo() {
        var brand = $("#w_brand").val();
        var phone = $("#w_phone").val();
        var address = $("#w_address").val();
        var contact = $("#w_contact").val();

        if (brand.trim() == "") {
            app.warning("请输入厂家名称");
            return;
        }

        if (app.win_action == 'add') {
            var options = {
                url: 'AddNewManufacturer',
                data: {
                    Name: brand.trim(),
                    Address: address.trim(),
                    CompanyPhone: phone.trim(),
                    Contact: contact.trim(),
                    ElevatorTypes: brand_type_members,
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "add",
                    refresh: brand_refresh,
                    key: brand.trim(),
                }
            };

            app.execPostRequest(options);
        } else {
            var options = {
                url: 'ChangeManufacturerInfo',
                data: {
                    Name: brand.trim(),
                    Address: address.trim(),
                    CompanyPhone: phone.trim(),
                    Contact: contact.trim(),
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "edit",
                    refresh: brand_refresh,
                    key: brand.trim(),
                }
            };

            app.execPostRequest(options);
        }
    }

    function addBrandTypeList(res, params) {
        var html = '<li class="dd-item" data-value="' + res + '">'
            + '<div class="dd-handle">'
            + '<a style="color: #ed5565;"  href="javascript:;" onclick="doRemoveBrandType(this)">删除</a>'
            + '&nbsp;&nbsp;<i class="fa fa-trophy"></i>&nbsp;型号：' + res
            + '</div>'
            + '</li>';
        $(".dd-list").append(html);
    }

    function doRemoveBrandType(obj) {
        app.delete(function () {
            var li = $(obj).parents("li");
            var value = $(li).data("value");
            if (app.win_action == "add") {
                brand_type_members.splice(jQuery.inArray(value, brand_type_members), 1);
                $(li).remove();
            } else {
                var options = {
                    url: 'DelManufacturerType',
                    data: {
                        ManufacturerName: app.win_key,
                        TypeName: value,
                    },
                    callback: function (res, params) {
                        res = eval("(" + res + ")");
                        if (res.code == 10000) {
                            $(params.li).remove();
                        } else {
                            app.error(res.msg);
                        }
                    },
                    callback_params: {
                        li: li,
                    }
                };
                app.execPostRequest(options);
            }
        });
    }

    function doAddBrandType() {
        var brand = $("#w_brand").val();        
        if (brand.trim() == "") {
            app.info("请输入厂家名称");
            return;
        }
        var brand_num = $("#w_brand_num").val();        
        if (brand_num.trim() == "") {
            app.info("请输入型号");
            return;
        }

        var flag = false;
        $(".dd-item").each(function () {
            if (brand_num.trim() == $(this).data("value")) {
                flag = true;
            }
        });
        if (flag) {
            app.error("已经添加过该型号");
            return;
        }
        if (app.win_action == "add") {
            brand_type_members.push(brand_num.trim());
            addBrandTypeList(brand_num.trim(), {});
        } else {
            var options = {
                url: 'AddManufacturerType',
                data: {
                    ManufacturerName: brand,
                    TypeName: brand_num.trim(),
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        var brand_num = $("#w_brand_num").val();  
                        addBrandTypeList(brand_num.trim(), {});
                    } else {
                        app.error(res.msg);
                    }
                },
                callback_params: {
                }
            };
            app.execPostRequest(options);
        }
    }
</script>