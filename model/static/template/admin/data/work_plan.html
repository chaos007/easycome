<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>工作日历</title>
    <link href="../../res/admin/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap-combobox.css" rel="stylesheet">

    <link href="../../res/admin/css/plugins/jQueryUI/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/jqGrid/ui.jqgrid.css" rel="stylesheet">

    <!-- Toastr style -->
    <link href="../../res/admin/css/plugins/toastr/toastr.min.css" rel="stylesheet">

    <!-- Sweet Alert -->
    <link href="../../res/admin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="../../res/admin/css/animate.css" rel="stylesheet">
    <link href="../../res/admin/css/style.css" rel="stylesheet">

    <!-- iCheck -->
    <link href="../../res/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">

    <!-- Clock Picker -->
    <link href="../../res/admin/css/plugins/clockpicker/clockpicker.css" rel="stylesheet">

    <!-- Data picker -->
    <link href="../../res/admin/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

    <!-- Full Calendar -->
    <link href="../../res/admin/css/plugins/fullcalendar/fullcalendar.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/fullcalendar/fullcalendar.print.css" rel='stylesheet' media='print'>
</head>

<body class="gray-bg">
    <div id="inner-wrapper">
        <div class="wrapper wrapper-content  animated fadeInRight" style="padding: 0; ">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox " style="border: none;">
                        <div class="ibox-content ">
                            <div id="search-form" style="margin-bottom: 10px;">
                                <div class="form-inline">
                                    <div class="form-group">
                                        <label for="group" class="sr-only">选择小组</label>
                                        <select class="combobox form-control" id="group" onchange="doGroupChange()">
                                            <option value="" selected="selected">选择小组</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="person" class="sr-only">选择人员</label>
                                        <select class="combobox form-control" id="person">
                                            <option value="" selected="selected">选择人员</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <div class="input-group date">
                                            <span class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </span>
                                            <input id="year_month" type="text" class="form-control" value="" placeholder="选择月份">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="doSearchPlan()">查询</button>
                                </div>
                            </div>

                            <div id="calendar"></div>
                            <div class="ibox" id="task_detail" style="display: none;">
                                <div class="ibox-title">
                                    <h3>工单详情</h3>
                                </div>
                                <div class="ibox-content">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <div class="ibox">
                                                <div class="ibox-content">
                                                    <h3>未执行
                                                        <span class="todo"></span>/
                                                        <span class="total"></span>
                                                    </h3>

                                                    <div class="flot-chart">
                                                        <div class="flot-chart-pie-content" id="flot-pie-chart-todo"></div>
                                                    </div>

                                                    <ul class="sortable-list connectList agile-list" id="todo">

                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <div class="ibox">
                                                <div class="ibox-content">
                                                    <h3>待处理
                                                        <span class="inprogress"></span>/
                                                        <span class="total"></span>
                                                    </h3>

                                                    <div class="flot-chart">
                                                        <div class="flot-chart-pie-content" id="flot-pie-chart-inprogress"></div>
                                                    </div>

                                                    <ul class="sortable-list connectList agile-list" id="inprogress">

                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <div class="ibox">
                                                <div class="ibox-content">
                                                    <h3>已完成
                                                        <span class="completed"></span>/
                                                        <span class="total"></span>
                                                    </h3>

                                                    <div class="flot-chart">
                                                        <div class="flot-chart-pie-content" id="flot-pie-chart-completed"></div>
                                                    </div>

                                                    <ul class="sortable-list connectList agile-list" id="completed">

                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <div class="ibox">
                                                <div class="ibox-content">
                                                    <h3>异常关闭
                                                        <span class="unusual"></span>/
                                                        <span class="total"></span>
                                                    </h3>

                                                    <div class="flot-chart">
                                                        <div class="flot-chart-pie-content" id="flot-pie-chart-unusual"></div>
                                                    </div>

                                                    <ul class="sortable-list connectList agile-list" id="unusual">

                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal inmodal" id="win" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-lg" style="width: 90%;">
            <div class="modal-content animated fadeIn">

            </div>
        </div>
    </div>

    <script src="../../res/admin/js/jquery-2.1.1.js"></script>
    <script src="../../res/admin/js/bootstrap.min.js"></script>
    <script src="../../res/admin/js/bootstrap-combobox.js"></script>

    <!-- Toastr script -->
    <script src="../../res/admin/js/plugins/toastr/toastr.min.js"></script>

    <!-- Sweet alert -->
    <script src="../../res/admin/js/plugins/sweetalert/sweetalert.min.js"></script>

    <!-- jqGrid -->
    <script src="../../res/admin/js/plugins/jqGrid/i18n/grid.locale-en.js"></script>
    <script src="../../res/admin/js/plugins/jqGrid/jquery.jqGrid.min.js"></script>

    <!-- iCheck -->
    <script src="../../res/admin/js/plugins/iCheck/icheck.min.js"></script>

    <script src="https://cdn.bootcss.com/blueimp-md5/2.6.0/js/md5.js"></script>
    <script src="../../res/admin/js/app.js"></script>

    <!-- Clock picker -->
    <script src="../../res/admin/js/plugins/clockpicker/clockpicker.js"></script>

    <!-- Data picker -->
    <script src="../../res/admin/js/plugins/datapicker/bootstrap-datepicker.js"></script>
    <script src="../../res/admin/js/plugins/datapicker/locales/bootstrap-datepicker.zh-CN.js"></script>

    <!-- Full Calendar -->
    <script src="../../res/admin/js/plugins/fullcalendar/moment.min.js"></script>
    <script src="../../res/admin/js/plugins/fullcalendar/fullcalendar.min.js"></script>

    <!-- Flot -->
    <script src="../../res/admin/js/plugins/flot/jquery.flot.js"></script>
    <script src="../../res/admin/js/plugins/flot/jquery.flot.tooltip.min.js"></script>
    <script src="../../res/admin/js/plugins/flot/jquery.flot.resize.js"></script>
    <script src="../../res/admin/js/plugins/flot/jquery.flot.pie.js"></script>
    <script src="../../res/admin/js/plugins/flot/jquery.flot.time.js"></script>
    <script>
        var DaythTime = 0;
        var Name = "";
        var Type = "";
        var TicketType = "";
        $(document).ready(function () {
            $("#location", window.parent.document).html("后台管理 >数据分析 >工作日历");

            app.initCombobox({
                url: 'GetTeamInfo',
                callback_params: {
                    id: 'group',
                }
            })

            $("#person").combobox({});

            var date = new Date();
            var m = date.getMonth() + 1;
            var y = date.getFullYear();
            var year_month = y;
            if (m < 10) {
                m = '0' + m;
            }
            $("#year_month").val(y + '-' + m);
            $('.input-group.date').datepicker({
                language: 'zh-CN',
                keyboardNavigation: false,
                forceParse: false,
                autoclose: true,
                startView: 1,
                maxViewMode: 1,
                minViewMode: 1,
                format: "yyyy-mm"
            });

            $('#calendar').fullCalendar({
                header: {
                    left: '',
                    center: 'title',
                },
                titleFormat: {
                    month: "YYYY年MM月",
                },
                buttonText: {
                    today: "今天",
                },
                dayNamesShort: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"],
                eventClick: function (event, jsEvent, view) {
                    var color = event.color;
                    if (color == "blue") {
                        TicketType = 1;
                    } else if (color == "pink") {
                        TicketType = 2;
                    } else if (color == "green") {
                        TicketType = 3;
                    } else if (color == "red") {
                        TicketType = 4;
                    } else if (color ==  "orange") {
                        TicketType = 5;
                    } else if (color ==  "purple" ) {
                        TicketType = 6;
                    }else if (color == "midnightBule"){
                        TicketType = 7;
                    }

                    var start = event.start._d;
                    DaythTime = new Date(start).getTime() / 1000;

                    var teamName = $("#group").val();

                    var options = {
                        url: 'GetTicketCalenarDay',
                        data: {
                            DaythTime: DaythTime,
                            Name: Name,
                            OtherMaintainTeam: teamName,
                            Type: Type,
                            TicketType: TicketType,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                var total = res.data.List.length;
                                $(".total").html(total);
                                var to_do = [];
                                var in_progress = [];
                                var completed = [];
                                var unusual = [];
                                res.data.List.forEach(function (v, i, a) {
                                    if (v.State == "开始" || v.State == "已查看" || v.State == "已签到" || v.State == "已派单"
                                    ) {
                                        to_do.push(v);
                                    } else if (v.State == "已关闭") {
                                        if (v.IsUnusual) {
                                            unusual.push(v);
                                        } else {
                                            completed.push(v);
                                        }
                                    } else {
                                        in_progress.push(v)
                                    }
                                });

                                $.plot($("#flot-pie-chart-todo"), [{
                                    label: '未执行',
                                    data: to_do.length,
                                    color: "#1c84c6"
                                },
                                {
                                    //                                    label: '其他',
                                    data: total - to_do.length,
                                    color: "#ffffff",
                                }], {
                                        series: {
                                            pie: {
                                                show: true
                                            }
                                        },
                                        grid: {
                                            hoverable: true
                                        },
                                        tooltip: true,
                                        tooltipOpts: {
                                            content: "%p.0%", // show percentages, rounding to 2 decimal places
                                            shifts: {
                                                x: 20,
                                                y: 0
                                            },
                                            defaultTheme: false
                                        }
                                    });

                                $.plot($("#flot-pie-chart-inprogress"), [{
                                    label: '待处理',
                                    data: in_progress.length,
                                    color: "#f8ac59"
                                },
                                {
                                    //                                    label: '其他',
                                    data: total - in_progress.length,
                                    color: "#ffffff"
                                }], {
                                        series: {
                                            pie: {
                                                show: true
                                            }
                                        },
                                        grid: {
                                            hoverable: true
                                        },
                                        tooltip: true,
                                        tooltipOpts: {
                                            content: "%p.0%", // show percentages, rounding to 2 decimal places
                                            shifts: {
                                                x: 20,
                                                y: 0
                                            },
                                            defaultTheme: false
                                        }
                                    });


                                $.plot($("#flot-pie-chart-completed"), [{
                                    label: '已完成',
                                    data: completed.length,
                                    color: "#1ab394"
                                },
                                {
                                    //                                    label: '其他',
                                    data: total - completed.length,
                                    color: "#ffffff"
                                }], {
                                        series: {
                                            pie: {
                                                show: true
                                            }
                                        },
                                        grid: {
                                            hoverable: true
                                        },
                                        tooltip: true,
                                        tooltipOpts: {
                                            content: "%p.0%", // show percentages, rounding to 2 decimal places
                                            shifts: {
                                                x: 20,
                                                y: 0
                                            },
                                            defaultTheme: false
                                        }
                                    });

                                $.plot($("#flot-pie-chart-unusual"), [{
                                    label: '异常关闭',
                                    data: unusual.length,
                                    color: 'red'
                                },
                                {
                                    //                                    label: '其他',
                                    data: total - unusual.length,
                                    color: "#ffffff"
                                }], {
                                        series: {
                                            pie: {
                                                show: true
                                            }
                                        },
                                        grid: {
                                            hoverable: true
                                        },
                                        tooltip: true,
                                        tooltipOpts: {
                                            content: "%p.0%", // show percentages, rounding to 2 decimal places
                                            shifts: {
                                                x: 20,
                                                y: 0
                                            },
                                            defaultTheme: false
                                        }
                                    });

                                $("#todo").empty();
                                $(".todo").html(to_do.length);

                                to_do.forEach(function (v, i, a) {
                                    var _html = "";
                                    if (TicketType == 5) {
                                        _html = '<div class="agile-detail">'
                                            + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkFinishTime) + '</span>计划完成时间：'
                                            + '</div>';
                                    }
                                    //大修整改
                                    var action_html = "";
                                    if (TicketType == 5) {
                                        var url_tip = "../protect/lift_big_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_big_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 4) {
                                        var url_tip = "../protect/lift_check_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_check_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 3) {
                                        var url_tip = "../protect/lift_filter_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_filter_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 2 || TicketType == 6) {
                                        var url_tip = "../protect/lift_year_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_year_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 1) {
                                        var url_tip = "../protect/lift_maintain_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_maintain_history.html?key=" + encodeURIComponent(v.TicketID);
                                    }

                                    action_html = '<div class="agile-detail">'
                                        + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                        + "<a class='btn btn-xs btn-primary' style='margin-left: 10px;'  href='" + url_history + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-history'></i>&nbsp;处理历史</a>"
                                        + '</div>';
                                    var html = '<li class="info-element">'
                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketID + '</span>工单号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.ElevatorNum + '</span>电梯号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketType + '</span>工单类型：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkTime) + '</span>计划工作时间：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.PlanWorkPerson + '</span>计划执行人：'
                                        + '</div>'

                                        + _html

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.State + '</span>工单状态：'
                                        + '</div>'

                                        + action_html

                                        + '</li>';

                                    $("#todo").append(html);
                                })

                                $("#inprogress").empty();
                                $(".inprogress").html(in_progress.length);
                                in_progress.forEach(function (v, i, a) {
                                    var _html = "";
                                    if (TicketType == 5) {
                                        _html = '<div class="agile-detail">'
                                            + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkFinishTime) + '</span>计划完成时间：'
                                            + '</div>';
                                    }
                                    //大修整改
                                    var action_html = "";
                                    if (TicketType == 5) {
                                        var url_tip = "../protect/lift_big_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_big_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 4) {
                                        var url_tip = "../protect/lift_check_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_check_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 3) {
                                        var url_tip = "../protect/lift_filter_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_filter_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 2|| TicketType == 6) {
                                        var url_tip = "../protect/lift_year_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_year_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 1) {
                                        var url_tip = "../protect/lift_maintain_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_maintain_history.html?key=" + encodeURIComponent(v.TicketID);
                                    }
                                    action_html = '<div class="agile-detail">'
                                        + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                        + "<a class='btn btn-xs btn-primary' style='margin-left: 10px;'  href='" + url_history + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-history'></i>&nbsp;处理历史</a>"
                                        + '</div>'

                                    var html = '<li class="warning-element">'
                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketID + '</span>工单号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.ElevatorNum + '</span>电梯号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketType + '</span>工单类型：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkTime) + '</span>计划工作时间：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.PlanWorkPerson + '</span>计划执行人：'
                                        + '</div>'

                                        + _html

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.State + '</span>工单状态：'
                                        + '</div>'

                                        + action_html

                                        + '</li>';

                                    $("#inprogress").append(html);
                                })

                                $("#completed").empty();
                                $(".completed").html(completed.length);
                                completed.forEach(function (v, i, a) {
                                    var _html = "";
                                    if (TicketType == 5) {
                                        _html = '<div class="agile-detail">'
                                            + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkFinishTime) + '</span>计划完成时间：'
                                            + '</div>';
                                    }

                                    //大修整改
                                    var action_html = "";
                                    if (TicketType == 5) {
                                        var url_tip = "../protect/lift_big_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_big_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 4) {
                                        var url_tip = "../protect/lift_check_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_check_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 3) {
                                        var url_tip = "../protect/lift_filter_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_filter_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 2) {
                                        var url_tip = "../protect/lift_year_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_year_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 1) {
                                        var url_tip = "../protect/lift_maintain_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_maintain_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 7) {
                                        var url_tip = "../protect/maintain_other_tip.html?key=" + encodeURIComponent(v.TicketID);
                                    }
                                    if (TicketType == 7) {
                                        action_html = '<div class="agile-detail">'
                                            + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                            + '</div>'
                                    } else {
                                        action_html = '<div class="agile-detail">'
                                            + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                            + "<a class='btn btn-xs btn-primary' style='margin-left: 10px;'  href='" + url_history + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-history'></i>&nbsp;处理历史</a>"
                                            + '</div>'
                                    }
                                    var html = '<li class="success-element">'
                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketID + '</span>工单号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.ElevatorNum + '</span>电梯号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketType + '</span>工单类型：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkTime) + '</span>计划工作时间：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.PlanWorkPerson + '</span>计划执行人：'
                                        + '</div>'

                                        + _html

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.State + '</span>工单状态：'
                                        + '</div>'

                                        + action_html

                                        + '</li>';

                                    $("#completed").append(html);
                                })

                                $("#unusual").empty();
                                $(".unusual").html(unusual.length);
                                unusual.forEach(function (v, i, a) {
                                    var _html = "";
                                    if (TicketType == 5) {
                                        _html = '<div class="agile-detail">'
                                            + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkFinishTime) + '</span>计划完成时间：'
                                            + '</div>';
                                    }

                                    //大修整改
                                    var action_html = "";
                                    if (TicketType == 5) {
                                        var url_tip = "../protect/lift_big_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_big_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 4) {
                                        var url_tip = "../protect/lift_check_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_check_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 3) {
                                        var url_tip = "../protect/lift_filter_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_filter_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 2|| TicketType == 6) {
                                        var url_tip = "../protect/lift_year_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_year_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 1) {
                                        var url_tip = "../protect/lift_maintain_tip.html?key=" + encodeURIComponent(v.TicketID);
                                        var url_history = "../protect/lift_maintain_history.html?key=" + encodeURIComponent(v.TicketID);
                                    } else if (TicketType == 7) {
                                        var url_tip = "../protect/maintain_other_tip.html?key=" + encodeURIComponent(v.TicketID);
                                    }
                                    if (TicketType == 7) {
                                        action_html = '<div class="agile-detail">'
                                            + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                            + '</div>'
                                    } else {
                                        action_html = '<div class="agile-detail">'
                                            + "<a class='btn btn-xs btn-info'  href='" + url_tip + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;工单详情</a>"
                                            + "<a class='btn btn-xs btn-primary' style='margin-left: 10px;'  href='" + url_history + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-history'></i>&nbsp;处理历史</a>"
                                            + '</div>'
                                    }
                                    var html = '<li class="success-element">'
                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketID + '</span>工单号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.ElevatorNum + '</span>电梯号：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.TicketType + '</span>工单类型：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + app.formatDateFromUnix(v.PlanWorkTime) + '</span>计划工作时间：'
                                        + '</div>'

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.PlanWorkPerson + '</span>计划执行人：'
                                        + '</div>'

                                        + _html

                                        + '<div class="agile-detail">'
                                        + '<span  class="pull-right">' + v.State + '</span>工单状态：'
                                        + '</div>'

                                        + action_html

                                        + '</li>';

                                    $("#unusual").append(html);
                                })

                                $("#task_detail").show();
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };
                    app.execPostRequest(options);
                }
            });

            $(".fc-today-button").click(function () {
                doSearchPlan(1);
            });

            $(".fc-prev-button").click(function () {
                doSearchPlan(1);
            });

            $(".fc-next-button").click(function () {
                doSearchPlan(1);
            });

            $("#win").on("hidden.bs.modal", function () {
                $(this).removeData("bs.modal");
            });
        });

        function doGroupChange() {
            var group = $("#group").val();
            $("#person").html('<option value="" selected="selected">选择人员</option>');
            if (group == "") {
                $("#person").combobox("clearTarget");
                $("#person").combobox("clearElement");
                $("#person").combobox("refresh");
            } else {
                app.initCombobox({
                    url: 'FindTeamMemberInfoWithKey',
                    data: {
                        TeamName: group,
                        UserName: "",
                    },
                    callback_params: {
                        id: 'person',
                        refresh: true,
                    }
                });
            }
        }

        function setCalendarData(MonthTime, Name, Type) {
            var options = {
                url: 'GetWorkCalenarMonth',
                data: {
                    MonthTime: parseInt(MonthTime),
                    Name: Name,
                    Type: parseInt(Type),
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        var events = [];
                        if (res.data.List && res.data.List.length > 0) {
                            res.data.List.forEach(function (v, i, a) {
                                var _date = v.DataNum;
                                _date = app.formatDateFromUnix(_date);
                                if (v.MaintainNum && v.MaintainNum > 0) {
                                    events.push({
                                        title: '维保 总:' + v.MaintainNum + " 未:" + v.MaintainBeginNum + " 待:" + v.MaintainWaitNum + " 异:" + v.MaintainUnusualCloseNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: "blue",
                                    });
                                }

                                if (v.YearCheckNum && v.YearCheckNum > 0) {
                                    events.push({
                                        title: '年检 总:' + v.YearCheckNum + " 未:" + v.YearCheckBeginNum + " 待:" + v.YearCheckWaitNum + " 异:" + v.YearCheckUnusualCloseNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'pink',
                                    });
                                }

                                if (v.SelfCheckNum && v.SelfCheckNum > 0) {
                                    events.push({
                                        title: '自检 总:' + v.SelfCheckNum + " 未:" + v.SelfCheckBeginNum + " 待:" + v.SelfCheckWaitNum + " 异:" + v.SelfCheckUnusualCloseNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'green',
                                    });
                                }

                                if (v.CheckAndFixNum && v.CheckAndFixNum > 0) {
                                    events.push({
                                        title: '急修 总:' + v.CheckAndFixNum + " 未:" + v.CheckAndFixBeginNum + " 待:" + v.CheckAndFixWaitNum + " 异:" + v.CheckAndFixUnusualCloseNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'red',
                                    });
                                }

                                if (v.BigCheckAndFixNum && v.BigCheckAndFixNum > 0) {
                                    events.push({
                                        title: '大修整改 总:' + v.BigCheckAndFixNum + " 未:" + v.BigCheckAndFixBeginNum + " 待:" + v.BigCheckAndFixWaitNum + " 异:" + v.BigCheckAndFixUnusualCloseNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'orange',
                                    });
                                }

                                if (v.YearLiveNum && v.YearLiveNum > 0) {
                                    events.push({
                                        title: '年检现场配合任务 ' + v.YearLiveNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'purple',
                                    });
                                }

                                if (v.OtherMaintainNum && v.OtherMaintainNum > 0) {
                                    events.push({
                                        title: '维保其他任务 ' + v.OtherMaintainNum,
                                        start: new Date(_date),
                                        allDay: true,
                                        color: 'midnightBule',
                                    });
                                }

                            })
                        }
                        //先清除之前查询的任务
                        $("#calendar").fullCalendar("removeEvents");
                        $("#calendar").fullCalendar('addEventSource', events);
                        $("#calendar").fullCalendar('gotoDate', new Date(app.formatDateFromUnix(MonthTime)));
                        $("#task_detail").hide();
                    } else {
                        app.error(res.msg);
                    }
                },
                callback_params: {}
            };

            app.execPostRequest(options);
        }

        function doSearchPlan(index) {
            var group = $("#group").val();

            Name = group;
            Type = 1;
            var person = $("#person").val();
            if (person != "") {
                Name = person;
                Type = 2;
            }

            if (index && index == 1) {
                var MonthTime = $("#calendar").fullCalendar('getDate');
                $('.input-group.date').datepicker("setDate", app.formatDateFromUnix(new Date(MonthTime).getTime() / 1000).substr(0, 7));
                setCalendarData(new Date(MonthTime).getTime() / 1000, Name, Type);
            } else {
                var MonthTime = $("#year_month").val();
                if (MonthTime == "") {
                    app.info("请选择查询月份");
                    return;
                }
                setCalendarData(new Date(MonthTime + "-01").getTime() / 1000, Name, Type);
            }
        }
    </script>
</body>

</html>