<div class="modal-header" style="padding: 15px">
    <button type="button" class="close" data-dismiss="modal">
        <span aria-hidden="true" style="font-size: 30px;">&times;</span>
        <span class="sr-only">Close</span>
    </button>
    <h6 class="modal-title">新增自检项目</h6>
</div>
<div class="modal-body">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>自检项目信息</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                <span class="input-required">*</span>项目名称
                            </label>

                            <div class="col-sm-10">
                                <input type="text" id="w_item" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                项目类型
                            </label>
                            <div class="col-sm-10">
                                <select class="form-control" id="w_sub_type">
                                    <option value="自检">自检</option>
                                    <option value="年检自检">年检自检</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">电梯类型</label>
                            <div class="col-sm-10">
                                <label class="radio-inline i-checks"> <input type="radio" checked="checked"
                                                                             name="w_type" value="直梯">直梯</label>
                                <label class="radio-inline i-checks"> <input type="radio" name="w_type"
                                                                             value="扶梯">扶梯</label>
                                <label class="radio-inline i-checks"> <input type="radio" name="w_type" value="杂物梯">杂物梯</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                备注
                            </label>

                            <div class="col-sm-10">
                                <input type="text" id="w_remark" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>自检标准</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                签到
                            </label>

                            <div class="col-sm-10">
                                <label class="radio-inline i-checks">
                                    <input type="radio" checked="checked" name="w_sign" value="终端点击签到">终端点击签到</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                反馈
                            </label>

                            <div class="col-sm-2">
                                <label class="radio-inline i-checks">
                                    <input type="radio" checked="checked" name="w_back" value="照片反馈">照片反馈
                                </label>
                            </div>
                            <div class="col-sm-4 flex">
                                照片不少于:
                                <div style="width: 120px;"><input id="w_back_num" value="0"></div>
                                张
                            </div>
                            <div class="col-sm-4 flex">
                                反馈说明:<input id="w_back_remark" style="width: 180px" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                其他
                            </label>

                            <div class="col-sm-2">
                                <label class="radio-inline i-checks">
                                    <input type="radio" checked="checked" name="w_other" value="超期时间">超期时间
                                </label>
                            </div>
                            <div class="col-sm-8 flex">
                                <div style="width: 120px;"><input id="w_other_day" value="3"></div>
                                天
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ibox">
                <div class="ibox-title">
                    <h5>自检单项</h5>
                </div>
                <div class="ibox-content">
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>机房</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_jf_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>井道</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_jd_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>厅门</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_tm_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>轿门</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_jm_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>轿厢</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_jx_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>坑底</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_kd_list">

                            </ul>
                        </div>
                    </div>
                    <div class="ibox">
                        <div class="ibox-title">
                            <h5>其他</h5>
                            <div class="ibox-tools">
                                <a class="collapse-link">
                                    <i class="fa fa-chevron-up"></i>
                                </a>
                            </div>
                        </div>
                        <div class="ibox-content">
                            <ul class="todo-list m-t small-list" id="w_qt_list">

                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-white" data-dismiss="modal">返回</button>
    <button type="button" class="btn btn-primary" onclick="saveItemCheckInfo()">确认</button>
</div>
<script>
    var ElevatorType = "直梯";
    $(function () {
        $('.collapse-link').click(function () {
            var ibox = $(this).closest('div.ibox');
            var button = $(this).find('i');
            var content = ibox.find('div.ibox-content');
            content.slideToggle(200);
            button.toggleClass('fa-chevron-up').toggleClass('fa-chevron-down');
            ibox.toggleClass('').toggleClass('border-bottom');
            setTimeout(function () {
                ibox.resize();
                ibox.find('[id^=map-]').resize();
            }, 50);
        });

        $('.i-checks').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
        });
        $("input[name='w_type']").on("ifClicked", function () {
            if (app.win_action == "edit") {
                var flag = false;
                $(":checkbox[name='w_check_item']").each(function () {
                    if ($(this).is(":checked")) {
                        flag = true;
                    }
                });
                if (flag) {
                    //删除选中的保养单项才能切换电梯类型
                    app.warning("请先去除已勾选的电梯类型为" + ElevatorType + "的自检单项，才能切换电梯类型");
                    //点击之后，恢复之前的选择状态
                    setTimeout(function () {
                        $(":radio[name='w_type'][value='" + ElevatorType + "']").iCheck("check");
                    }, 300)
                    return;
                }
                ElevatorType = $(this).val();
                getCheckItems();
            } else {
                ElevatorType = $(this).val();
                getCheckItems();
            }
        });

        app.win_action = 'add';
        if (app.win_url.indexOf("?key=") > 0) {
            app.win_action = 'edit';
            app.win_key = parseInt(app.win_url.split("?key=")[1]);
        }

        if (app.win_action == 'edit') {
            //编辑页面
            $(".modal-title").html("编辑自检项目")

            //获取info
            var options = {
                url: 'GetMaintainProjectWithKey',
                data: {
                    ID: app.win_key,
                },
                callback: initItemCheckInfo,
                callback_params: {}
            };

            app.execPostRequest(options);

        } else {
            $("#w_back_num").TouchSpin({
                max: 1000000,
                min: 0,
                width: "60px",
                buttondown_class: 'btn btn-white',
                buttonup_class: 'btn btn-white'
            });

            $("#w_other_day").TouchSpin({
                max: 1000000,
                min: 0,
                width: "60px",
                buttondown_class: 'btn btn-white',
                buttonup_class: 'btn btn-white'
            });

            getCheckItems();
        }
    });

    function initItemCheckInfo(res, params) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            if (res.data == null) {
                return;
            }

            var info = res.data;
            $("#w_item").val(info.ProjectName);
            $("#w_sub_type").val(info.IntervalType);
            $(":radio[name='w_type'][value='" + info.ElevatorType + "']").iCheck('check');
            ElevatorType = info.ElevatorType;
            $("#w_remark").val(info.Remark);

            $("#w_back_num").val(info.PhotoNum);
            $("#w_back_num").TouchSpin({
                max: 1000000,
                min: 0,
                buttondown_class: 'btn btn-white',
                buttonup_class: 'btn btn-white'
            });
            $("#w_back_remark").val(info.Instruction);

            $("#w_other_day").val(info.ExpireAlertDay);
            $("#w_other_day").TouchSpin({
                max: 1000000,
                min: 0,
                buttondown_class: 'btn btn-white',
                buttonup_class: 'btn btn-white'
            });
            getCheckItems(info.ItemList);
        } else {
            app.error(res.msg)
        }
    }

    function getCheckItems(select_items) {
        var options = {
            url: 'GetItemSelfCheckInfo',
            data: {
                ItemSelfCheckName: "",
                ElevatorZone: "",
                ElevatorType: ElevatorType
            },
            callback: initCheckItems,
            callback_params: {
                select_items: select_items,
            }
        };

        app.execPostRequest(options);
    }

    function initCheckItems(res, params) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            $("#w_jf_list").empty();
            $("#w_jd_list").empty();
            $("#w_tm_list").empty();
            $("#w_jm_list").empty();
            $("#w_jx_list").empty();
            $("#w_kd_list").empty();
            $("#w_qt_list").empty();
            var items = res.data;
            if (items && items.length > 0) {
                items.forEach(function (value, index, arr) {
                    var html = '<li>'
                        + ' <label class="check-inline i-checks checkbox-more"> <input type="checkbox" '
                        + (app.win_action == "edit" ? " disabled " : "")
                        + 'name="w_check_item"  value="' + value.ID + '">&nbsp;' + value.Name + '</label>'
                        + ' </li>';
                    switch (value.ElevatorZone) {
                        case "机房": {
                            $("#w_jf_list").append(html);
                            break;
                        }
                        case "井道": {
                            $("#w_jd_list").append(html);
                            break;
                        }
                        case "厅门": {
                            $("#w_tm_list").append(html);
                            break;
                        }
                        case "轿门": {
                            $("#w_jm_list").append(html);
                            break;
                        }
                        case "轿厢": {
                            $("#w_jx_list").append(html);
                            break;
                        }
                        case "坑底": {
                            $("#w_kd_list").append(html);
                            break;
                        }
                        case "其他": {
                            $("#w_qt_list").append(html);
                            break;
                        }
                    }
                });
            }

            if (params.select_items) {
                params.select_items.forEach(function (value, index, arr) {
                    $("input[name='w_check_item'][value='" + value.ID + "']").attr("checked", true);
                });
            }

            $('.checkbox-more').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });

            $("input[name='w_check_item']").on("ifClicked", function (event) {
                if (app.win_action == "edit") {
                    //编辑状态直接新增或者删除
                    var id = parseInt($(this).val());
                    //判断点击之前的状态
                    if ($(this).is(":checked")) {
                        //删除
                        var options = {
                            url: 'DelMaintainProjectItem',
                            data: {
                                ProjectID: app.win_key,
                                ItemID: id,
                            },
                            callback: function (res, params) {
                                res = eval("(" + res + ")");
                                if (res.code == 10000) {

                                } else {
                                    app.error(res.msg);
                                    //删除失败，恢复之前的选中状态
                                    setTimeout(function () {
                                        $(params.obj).iCheck("check");
                                    }, 300)
                                }
                            },
                            callback_params: {
                                obj: this
                            }
                        };

                        app.execPostRequest(options);
                    } else {
                        //新增
                        var options = {
                            url: 'AddMaintainProjectItem',
                            data: {
                                ProjectID: app.win_key,
                                ItemID: id,
                            },
                            callback: function (res, params) {
                                res = eval("(" + res + ")");
                                if (res.code == 10000) {

                                } else {
                                    app.error(res.msg);
                                    //新增失败，恢复之前的未选中状态
                                    setTimeout(function () {
                                        $(params.obj).iCheck("uncheck");
                                    }, 300)
                                }
                            },
                            callback_params: {
                                obj: this
                            }
                        };

                        app.execPostRequest(options);
                    }
                }
            })
        }
    }

    function saveItemCheckInfo() {
        var ProjectName = $("#w_item").val().trim();
        var IntervalType = $('#w_sub_type option:selected').val().trim();
        var Type = $("input[name='w_type']:checked").val();
        var Remark = $("#w_remark").val().trim();
        var PhotoNum = parseInt($("#w_back_num").val());
        var Instruction = $("#w_back_remark").val().trim();
        var ExpireAlertDay = parseInt($("#w_other_day").val());
        if (ProjectName == "") {
            app.warning("请输入项目名称");
            return;
        }

        if (app.win_action == 'add') {
            var ItemIDs = [];
            $(":checkbox[name='w_check_item']").each(function () {
                if ($(this).is(":checked")) {
                    var id = $(this).val();
                    ItemIDs.push(parseInt(id));
                }
            });

            var options = {
                url: 'AddMaintainProject',
                data: {
                    ProjectName: ProjectName,
                    Type: Type,
                    PhotoNum: PhotoNum,
                    Instruction: Instruction,
                    Remark: Remark,
                    ExpireAlertDay: ExpireAlertDay,
                    IntervalType: IntervalType,
                    ItemIDs: ItemIDs,
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "add",
                    refresh: item_refresh,
                    key: "new_key",
                }
            };

            app.execPostRequest(options);
        } else {

            var options = {
                url: 'ChangeMaintainProject',
                data: {
                    ID: app.win_key,
                    ProjectName: ProjectName,
                    Type: Type,
                    PhotoNum: PhotoNum,
                    Instruction: Instruction,
                    Remark: Remark,
                    ExpireAlertDay: ExpireAlertDay,
                    IntervalType: IntervalType,
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "edit",
                    refresh: item_refresh,
                    key: app.win_key,
                }
            };

            app.execPostRequest(options);
        }
    }
</script>