<div class="modal-header" style="padding: 15px">
    <button type="button" class="close" data-dismiss="modal">
        <span aria-hidden="true" style="font-size: 30px;">&times;</span>
        <span class="sr-only">Close</span>
    </button>
    <h6 class="modal-title">电梯维保工单处理历史</h6>
</div>
<div class="modal-body">
    <link rel="stylesheet" href="../../res/css/weui.css"/>
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>工单号：<span id="w_lift_maintain_TicketID"></span></h5>
                </div>
                <div class="ibox-content" id="history_list"></div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-white" data-dismiss="modal">返回</button>
</div>
<script>
    $(function () {
        app.win_action = 'add';
        if (app.win_url.indexOf("?key=") > 0) {
            app.win_action = 'edit';
            app.win_key = parseInt(decodeURIComponent(app.win_url.split("?key=")[1]));
            $("#w_lift_maintain_TicketID").html(app.win_key);
        }

        if (app.win_action == 'edit') {
            var options = {
                url: 'GetMaintainTicketHistory',
                data: {
                    TicketID: app.win_key,
                },
                callback: initLiftMaintainHistoryInfo,
                callback_params: {}
            };

            app.execPostRequest(options);
        }
    });

    function initLiftMaintainHistoryInfo(res, param) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            $("#history_list").html("");
            if (res.data) {
                res.data.forEach(function (value, index, arr) {
                    var html = "";
                    if (value.Type == "工单生成") {
                        var person_html = "";
                        if (value.MaintainLeader && value.MaintainLeader) {
                            person_html += value.MaintainLeader + "、";
                        }
                        if (value.MaintainMember && value.MaintainMember) {
                            person_html += value.MaintainMember + "、";
                        }
                        if (value.MaintainMember2 && value.MaintainMember2) {
                            person_html += value.MaintainMember2 + "、";
                        }
                        if (person_html.length > 0) {
                            person_html = person_html.substr(0, person_html.length - 1);
                        }

                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">维保人员</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + person_html + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">维保项目</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.MaintainName + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">计划保养时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateFromUnix(value.PlanMaintainTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "工作变更") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">变更后人员</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.ChangeAfterMember + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "反馈说明") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">反馈人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.ResultPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">反馈事项</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.ResultMessage + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "异常关闭") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">关闭原因</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.CloseReason + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "超期短信提醒") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">通知内容</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.TextMessage + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "终端签到") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">签到距离</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.Distance + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "结果录入") {
                        var _html = "";
                        if (value.UnusualItems) {
                            value.UnusualItems.forEach(function (v, index, arr) {
                                _html += "<span style='color: #00a0e9;'>" + v.PlaceName + "</span><br/>"
                                    + "<span>&nbsp;&nbsp;要求：" + v.UnusualDemond + "</span><br/>";
                                var UnusualWords = v.UnusualWords;
                                if (UnusualWords) {
                                    UnusualWords.forEach(function (vv, ii, aa) {
                                        _html += "<span>&nbsp;&nbsp;异常：" + vv + "</span><br/>";
                                    });
                                }
                            });
                        }

                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">异常单项</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + _html + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">建议</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.Advice + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">结果反馈</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRemark + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">签到距离</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.Distance + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">图片详情</label>'
                            + '<div class="col-sm-10">'

                            + '<div class="weui-form-preview__bd">'
                            + '<div class="weui-gallery" id="gallery_' + value.UnusualIndex + '">'
                            + '<span class="weui-gallery__img" id="galleryImg_' + value.UnusualIndex + '"></span>'
                            + '<div class="weui-gallery__opr">'
                            + '</div>'
                            + '</div>'
                            + '<div class="weui-uploader__bd">'
                            + '<ul class="weui-uploader__files" id="uploaderFiles_' + value.UnusualIndex + '">'
                            + '</ul>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';

                        $("#history_list").append(html);
                        var tmpl = '<li class="weui-uploader__file" style="background-image:url(#url#)"></li>',
                            $gallery = $("#gallery_" + value.UnusualIndex),
                            $galleryImg = $("#galleryImg_" + value.UnusualIndex),
                            $uploaderFiles = $("#uploaderFiles_" + value.UnusualIndex);
                        var options = {
                            url: 'GetTicketPhotoPlace',
                            data: {
                                TicketID: app.win_key,
                                UnusualIndex: value.UnusualIndex,
                            },
                            callback: function (res, params) {
                                res = eval("(" + res + ")");
                                console.log(res);
                                var images = res.data;
                                for (var i = 0; i < images.length; i++) {
                                    params.uploaderFiles.append($(tmpl.replace('#url#', images[i])));
                                }

                            },
                            callback_params: {
                                uploaderFiles: $uploaderFiles
                            }
                        };
                        app.execPostRequest(options);

                        $uploaderFiles.on("click", "li", function () {
                            $galleryImg.attr("style", this.getAttribute("style"));
                            $gallery.fadeIn(100);
                        });
                        $gallery.on("click", function () {
                            $gallery.fadeOut(100);
                        });
                    }
                    else if (value.Type == "电话联系") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">联系目标</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.PhoneTarget + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "审核") {
                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">审核结果</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + (value.VerifyAgree ? '同意' : '不同意') + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">审核意见</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.VerifySuggest + '</span>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'
                            + '</div>';
                    }
                    else if (value.Type == "结果补录") {
                        var _html = "";
                        if (value.UnusualItems) {
                            value.UnusualItems.forEach(function (v, index, arr) {
                                _html += "<span style='color: #00a0e9;'>" + v.PlaceName + "</span><br/>"
                                    + "<span>&nbsp;&nbsp;要求：" + v.UnusualDemond + "</span><br/>";
                                var UnusualWords = v.UnusualWords;
                                if (UnusualWords) {
                                    UnusualWords.forEach(function (vv, ii, aa) {
                                        _html += "<span>&nbsp;&nbsp;异常：" + vv + "</span><br/>";
                                    });
                                }
                            });
                        }

                        html += '<div class="ibox">'
                            + '<div class="ibox-title">'
                            + '<h5>' + value.Type + '</h5>'
                            + '</div>'
                            + '<div class="ibox-content" >'
                            + '<div class="form-horizontal">'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理人</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealPerson + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理角色</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRole + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">处理时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.DealTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">补录原因</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.LateReason + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">签到时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.LateStartTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">结束时间</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + app.formatDateTimeFromUnix(value.LateEndTime) + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">异常单项</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + _html + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">建议</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.Advice + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">结果反馈</label>'
                            + '<div class="col-sm-10">'
                            + '<span>' + value.DealRemark + '</span>'
                            + '</div>'
                            + '</div>'

                            + '<div class="form-group">'
                            + '<label class="col-sm-2" style="text-align: right">图片详情</label>'
                            + '<div class="col-sm-10">'

                            + '<div class="weui-form-preview__bd">'
                            + '<div class="weui-gallery" id="gallery_' + value.UnusualIndex + '">'
                            + '<span class="weui-gallery__img" id="galleryImg_' + value.UnusualIndex + '"></span>'
                            + '<div class="weui-gallery__opr">'
                            + '</div>'
                            + '</div>'
                            + '<div class="weui-uploader__bd">'
                            + '<ul class="weui-uploader__files" id="uploaderFiles_' + value.UnusualIndex + '">'
                            + '</ul>'
                            + '</div>'
                            + '</div>'

                            + '</div>'
                            + '</div>'

                            + '</dvi>'
                            + '</div>'
                            + '</div>';

                        $("#history_list").append(html);
                        var tmpl = '<li class="weui-uploader__file" style="background-image:url(#url#)"></li>',
                            $gallery = $("#gallery_" + value.UnusualIndex),
                            $galleryImg = $("#galleryImg_" + value.UnusualIndex),
                            $uploaderFiles = $("#uploaderFiles_" + value.UnusualIndex);
                        var options = {
                            url: 'GetTicketPhotoPlace',
                            data: {
                                TicketID: app.win_key,
                                UnusualIndex: value.UnusualIndex,
                            },
                            callback: function (res, params) {
                                res = eval("(" + res + ")");
                                console.log(res);
                                var images = res.data;
                                for (var i = 0; i < images.length; i++) {
                                    params.uploaderFiles.append($(tmpl.replace('#url#', images[i])));
                                }

                            },
                            callback_params: {
                                uploaderFiles: $uploaderFiles
                            }
                        };
                        app.execPostRequest(options);

                        $uploaderFiles.on("click", "li", function () {
                            $galleryImg.attr("style", this.getAttribute("style"));
                            $gallery.fadeIn(100);
                        });
                        $gallery.on("click", function () {
                            $gallery.fadeOut(100);
                        });
                    }

                    if (value.Type != "结果录入" && value.Type != "结果补录") {
                        $("#history_list").append(html);
                    }
                });
            }
        }
    }
</script>