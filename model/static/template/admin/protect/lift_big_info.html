<div class="modal-header" style="padding: 15px">
    <button type="button" class="close" data-dismiss="modal">
        <span aria-hidden="true" style="font-size: 30px;">&times;</span>
        <span class="sr-only">Close</span>
    </button>
    <h6 class="modal-title">新增大修整改工单</h6>
</div>
<div class="modal-body">
    <div class="row">

        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>电梯选择</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-inline" style="margin-bottom: 10px;">
                            <div class="form-group" style="margin: 0">
                                <div class="col-sm-10">
                                    <label for="w_property" class="sr-only">物业</label>
                                    <select class="combobox form-control" id="w_property" onchange="doPropertyChange()">
                                        <option value="" selected="selected">物业</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin: 0">
                                <div class="col-sm-10">
                                    <label for="w_project" class="sr-only">项目</label>
                                    <select class="combobox form-control" id="w_project" onchange="doProjectChange()">
                                        <option value="" selected="selected">项目</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" style="margin: 0">
                                <div class="col-sm-10">
                                    <label for="w_elevator" class="sr-only">电梯号</label>
                                    <select class="combobox form-control" id="w_elevator" onchange="doElevatorChange()">
                                        <option value="" selected="selected">电梯号</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                地址
                            </label>

                            <div class="col-sm-10">
                                <span id="w_lift_maintain_address"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                联系人及电话
                            </label>

                            <div class="col-sm-10">
                                <span id="w_lift_maintain_info"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-title">
                    <h5>工作描述</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                <span class="input-required">*</span> 任务事宜
                            </label>

                            <div class="col-sm-10">
                                <input class="form-control" id="w_problem">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                <span class="input-required">*</span>工单类型
                            </label>

                            <div class="col-sm-10">
                                <label class="radio-inline i-checks">
                                    <input type="radio" name="w_type" value="大修">大修
                                </label>
                                <label class="radio-inline i-checks">
                                    <input type="radio" name="w_type" value="整改">整改
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                <span class="input-required">*</span>要求完成时间
                            </label>

                            <div class="col-sm-10">
                                <div class="input-group date">
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                    <input id="w_plan_time" type="text" class="form-control" value=""
                                           placeholder="要求完成时间">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ibox-title">
                    <h5>申请信息</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                <span class="input-required">*</span>申请小组
                            </label>

                            <div class="col-sm-10">
                                <label for="w_BackGroup" class="sr-only">申请小组</label>
                                <select class="combobox form-control" id="w_BackGroup" onchange="doBackGroupChange()">
                                    <option value="" selected="selected">申请小组</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2" style="text-align: right">
                                <span class="input-required">*</span>申请人
                            </label>

                            <div class="col-sm-5">
                                <label for="w_BackName" class="sr-only">申请人</label>
                                <select class="combobox form-control" id="w_BackName" onchange="doBackNameChange()">
                                    <option value="" selected="selected">申请人</option>
                                </select>
                            </div>
                            <div class="col-sm-5">
                                <span id="w_BackInfo"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-white" data-dismiss="modal">返回</button>
    <button type="button" class="btn btn-primary" onclick="saveLiftCheckInfo()">确认</button>
</div>
<script>
    $(function () {
        app.win_action = 'add';

        $('.i-checks').iCheck({
            checkboxClass: 'icheckbox_square-green',
            radioClass: 'iradio_square-green',
        });

        $('.input-group.date').datepicker({
            language: 'zh-CN',
            todayBtn: "linked",
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true,
        });

        app.initCombobox({
            url: 'GetPropertyName',
            callback_params: {
                id: 'w_property',
            }
        });

        app.initCombobox({
            url: 'GetProjectName',
            callback_params: {
                id: 'w_project',
            }
        });

        app.initCombobox({
            url: 'GetElevatorNumByProject',
            callback_params: {
                id: 'w_elevator',
            }
        });

        app.initCombobox({
            url: 'GetTeamInfo',
            callback_params: {
                id: 'w_BackGroup',
            }
        })

        $("#w_BackName").combobox();
    });

    function doPropertyChange() {
        var property = $("#w_property").val();
        $("#w_project").html('<option value="" selected="selected">项目</option>');
        $("#w_elevator").html('<option value="" selected="selected">电梯号</option>');

        app.initCombobox({
            url: 'GetProjectName',
            data: {
                PropertyName: property.trim(),
            },
            callback_params: {
                id: 'w_project',
                refresh: true,
            }
        });
        app.initCombobox({
            url: 'GetElevatorNumByProject',
            data: {
                PropertyName: property.trim(),
            },
            callback_params: {
                id: 'w_elevator',
                refresh: true,
            }
        });

        $("#w_lift_maintain_address").html("");
        $("#w_lift_maintain_info").html("");
    }

    function doProjectChange() {
        var project = $("#w_project").val();
        var property = $("#w_property").val();
        if (project.trim() == ""){
            return
        }
        $("#w_elevator").html('<option value="" selected="selected">电梯号</option>');
        app.initCombobox({
            url: 'GetElevatorNumByProject',
            data: {
                PropertyName: property.trim(),
                ProjectName: project.trim(),
            },
            callback_params: {
                id: 'w_elevator',
                refresh: true,
            }
        });

        $("#w_lift_maintain_address").html("");
        $("#w_lift_maintain_info").html("");
    }

    function doElevatorChange() {
        var elevator = $("#w_elevator").val();
        if (elevator == "") {
            $("#w_lift_maintain_address").html("");
            $("#w_lift_maintain_info").html("");
        } else {
            var options = {
                url: 'GetElevatorInfoByNum',
                data: {
                    ElevatorNum: elevator,
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        var info = res.data;
                        var Contracts = "";
                        if (info.BuildingInfo) {
                            info.BuildingInfo.forEach(function (value, index, arr) {
                                Contracts += value.Remark + " " + value.PersonName + " " + value.Phone + ";<br/>";
                            });
                        }
                        $("#w_lift_maintain_address").html(info.Address);
                        $("#w_lift_maintain_info").html(Contracts);

                    } else {
                        $("#w_lift_maintain_address").html("");
                        $("#w_lift_maintain_info").html("");
                        app.error(res.msg);
                    }
                },
                callback_params: {}
            };

            app.execPostRequest(options);
        }
    }

    function doBackGroupChange() {
        var group = $("#w_BackGroup").val();
        $("#w_BackName").html('<option value="" selected="selected">申请人</option>');
        if (group == "") {
            $("#w_BackName").combobox("clearTarget");
            $("#w_BackName").combobox("clearElement");
            $("#w_BackName").combobox("refresh");
        } else {
            app.initCombobox({
                url: 'FindTeamMemberInfoWithKey',
                data: {
                    TeamName: group,
                    UserName: "",
                },
                callback_params: {
                    id: 'w_BackName',
                    refresh: true,
                }
            });
        }

        $("#w_BackInfo").html("");
    }

    function doBackNameChange() {
        var username = $("#w_BackName").val();
        if (username == "") {
            $("#w_BackInfo").html("");
        } else {
            var options = {
                url: 'FindTeamMemberInfoWithKey',
                data: {
                    TeamName: $("#w_BackGroup").val(),
                    UserName: username,
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        if (res.data == null || res.data.length == 0) {
                            $("#w_BackInfo").html("");
                        } else {
                            $("#w_BackInfo").html((res.data[0].IsLeader ? '组长' : '组员')
                                + " " + res.data[0].PersonName
                                + " " + res.data[0].Phone);
                        }
                    } else {
                        $("#w_BackInfo").html("");
                        $("#w_BackName").combobox("clearTarget");
                        $("#w_BackName").combobox("refresh");
                        app.error(res.msg);
                    }
                },
                callback_params: {}
            };

            app.execPostRequest(options);
        }
    }

    function saveLiftCheckInfo() {
        var ElevatorNum = $("#w_elevator").val();
        if (ElevatorNum == "") {
            app.warning("请先选择电梯");
            return;
        }

        var ProblemDesc = $("#w_problem").val();
        if (ProblemDesc == "") {
            app.warning("请输入任务事宜");
            return;
        }

        var type = $("input[name='w_type']:checked").val();
        if (type == null) {
            app.warning("请选择工单类型");
            return;
        }
        var IsBigFix = false;
        var IsBigCheck = false;
        if (type == "大修") {
            IsBigFix = true;
            IsBigCheck = false;
        } else if (type == "整改") {
            IsBigFix = false;
            IsBigCheck = true;
        }
        var TimeStr = $("#w_plan_time").val();
        if(TimeStr.trim()==""){
            app.warning("请选择要求完成时间");
            return;
        }
        var CreatePerson = $("#w_BackName").val();
        if(CreatePerson==""){
            app.warning("请选择申请人");
            return;
        }

        var options = {
            url: 'AddBigCheckAndFixTicket',
            data: {
                UserName: app.getLoginUserName(),
                ElevatorNum: ElevatorNum,
                ProblemDesc: ProblemDesc,
                IsBigFix: IsBigFix,
                IsBigCheck: IsBigCheck,
                CreatePerson: CreatePerson,
                ShouldDealTime: new Date(TimeStr).getTime() / 1000,
            },
            callback: app.saveCallbackWindow,
            callback_params: {
                action: "add",
                refresh: lift_big_refresh,
                key: 'new_key',
            }
        };

        app.execPostRequest(options);
    }
</script>