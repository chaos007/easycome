<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>工作交接</title>
    <link href="../../res/admin/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap-combobox.css" rel="stylesheet">

    <!-- Toastr style -->
    <link href="../../res/admin/css/plugins/toastr/toastr.min.css" rel="stylesheet">

    <!-- Sweet Alert -->
    <link href="../../res/admin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="../../res/admin/css/animate.css" rel="stylesheet">
    <link href="../../res/admin/css/style.css" rel="stylesheet">

    <!-- iCheck -->
    <link href="../../res/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">
</head>

<body>
    <div class="ibox" style="margin-bottom: 0">
        <div class="ibox-title">
            <h5>电梯交接</h5>
        </div>
        <div class="ibox-content">
            <div class="form-horizontal">
                <div class="form-group">
                    <label class="col-sm-2" style="text-align: right">
                        电梯编号
                    </label>

                    <div class="col-sm-10">
                        <span id="layer_ElevatorNum"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2" style="text-align: right">交接类型</label>
                    <div class="col-sm-10">
                        <span id="layer_TicketType"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2" style="text-align: right">当前小组</label>
                    <div class="col-sm-10">
                        <span id="layer_OldTeam"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-sm-2" style="text-align: right">交接小组</label>
                    <div class="col-sm-6">
                        <label for="layer_NewTeam" class="sr-only">选择小组</label>
                        <select class="combobox form-control" id="layer_NewTeam" onchange="doNewTeamChange()">
                            <option value="" selected="selected">选择小组</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="layer_Persons">

                </div>
            </div>
        </div>
        <div class="ibox-title">
            <h5>电梯未关闭工单交接</h5>
        </div>
        <div class="ibox-content">
            <div class="form-horizontal" id="layer_Tickets">

            </div>
            <div class="clearfix">
                <button class="btn btn-primary pull-right" style="margin-right: 30px;" onclick="doWorkReplace()">确认</button>
            </div>
        </div>
    </div>
    <script src="../../res/admin/js/jquery-2.1.1.js"></script>
    <script src="../../res/admin/js/bootstrap.min.js"></script>
    <script src="../../res/admin/js/bootstrap-combobox.js"></script>

    <!-- Toastr script -->
    <script src="../../res/admin/js/plugins/toastr/toastr.min.js"></script>

    <!-- Sweet alert -->
    <script src="../../res/admin/js/plugins/sweetalert/sweetalert.min.js"></script>

    <!-- iCheck -->
    <script src="../../res/admin/js/plugins/iCheck/icheck.min.js"></script>

    <script src="https://cdn.bootcss.com/blueimp-md5/2.6.0/js/md5.js"></script>
    <script src="../../res/admin/js/app.js"></script>

    <script src="../../res/js/layer/layer-min.js"></script>
    <script>
        var TicketType = "";
        var ElevatorNum = "";
        var TicketIDS = [];
        var list = [];

        $(document).ready(function () {
            list = localStorage.getItem("list").split(",");
            if (!list) {
                app.warning("请选择电梯");
                return
            }
            var index = localStorage.getItem("index");
            var team = localStorage.getItem("team");

            if (index == 1) {
                TicketType = "维保";
            } else if (index == 2) {
                TicketType = "检修";
            } else if (index == 3) {
                TicketType = "大修整改";
            } else if (index == 4) {
                TicketType = "年检自检";
            } else if (index == 5) {
                TicketType = "自检";
            }

            $("#layer_ElevatorNum").html(localStorage.getItem("list"));
            $("#layer_TicketType").html(TicketType);
            $("#layer_OldTeam").html(team);
            app.initCombobox({
                url: 'GetTeamInfoWithType',
                data: {
                    Type: TicketType,
                },
                callback_params: {
                    id: 'layer_NewTeam',
                }
            });

            if (TicketType == "维保") {
                var html = '<label class="col-sm-2" style="text-align: right">新维保人员</label>'
                    + '<div class="col-sm-6">'
                    + '<label for="layer_Person1" class="sr-only">选择维保组员</label>'
                    + '<select class="combobox form-control" id="layer_Person1">'
                    + '<option value="" selected="selected">选择维保组员</option>'
                    + '</select>'
                    + '<br/>'
                    + '<label for="layer_Person2" class="sr-only">选择维保组员</label>'
                    + '<select class="combobox form-control" id="layer_Person2">'
                    + '<option value="" selected="selected">选择维保组员</option>'
                    + '</select>'
                    + '<br/>'
                    + '<label for="layer_Person3" class="sr-only">选择维保组员</label>'
                    + '<select class="combobox form-control" id="layer_Person3">'
                    + '<option value="" selected="selected">选择维保组员</option>'
                    + '</select>'
                    + '</div>';
                $("#layer_Persons").html(html);

                $("#layer_Person1").combobox({});
                $("#layer_Person2").combobox({});
                $("#layer_Person3").combobox({});
            }
            else if (TicketType == "年检自检") {
                var html = '<label class="col-sm-2" style="text-align: right">新年检人员</label>'
                    + '<div class="col-sm-6">'
                    + '<label for="layer_Person1" class="sr-only">选择年检自检组长</label>'
                    + '<select class="combobox form-control" id="layer_Person1" >'
                    + '<option value="" selected="selected">选择年检自检组长</option>'
                    + '</select>'
                    + '<br/>'
                    + '<label for="layer_Person2" class="sr-only">选择年检自检组员</label>'
                    + '<select class="combobox form-control" id="layer_Person2">'
                    + '<option value="" selected="selected">选择年检自检组员</option>'
                    + '</select>'
                    + '</div>';
                $("#layer_Persons").html(html);

                $("#layer_Person1").combobox({});
                $("#layer_Person2").combobox({});
            }

            //获取未关闭工单
            var options = {
                url: 'GetLotsElevatorUncloseTikcet',
                data: {
                    ElevatorNumList: list,
                    TicketType: TicketType,
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        if (res.data.List && res.data.List.length > 0) {
                            res.data.List.forEach(function (v, i, a) {
                                TicketIDS.push(v.TicketID);
                                if (TicketType == "维保") {
                                    var html = '<div class="form-group">'

                                        + '<label class="col-sm-3">'
                                        + '工单号：' + v.TicketID
                                        + '</label>'

                                        + '<label class="col-sm-2">'
                                        + '工单状态：' + v.State
                                        + '</label>'

                                        + '<label class="col-sm-3">'
                                        + '工作描述：' + v.TicketType
                                        + '</label>'

                                        + '<label class="col-sm-4">'
                                        + '当前处理人：' + v.DutyPerson
                                        + '</label>'

                                        + '</div>'

                                        + '<div class="form-group">'
                                        + '<div style="padding: 0 100px;">'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="1">异常关闭当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="2">异常关闭该工单，并按新人员重新生成当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<div class="form-inline" style="padding-left:  30px;">'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_1" class="sr-only">选择维保组员</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_1">'
                                        + '<option value="" selected="selected">选择维保组员</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_2" class="sr-only">选择维保组员</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_2">'
                                        + '<option value="" selected="selected">选择维保组员</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_3" class="sr-only">选择维保组员</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_3">'
                                        + '<option value="" selected="selected">选择维保组员</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '</div>'

                                        + '</div>'

                                        + '</div>';

                                    $("#layer_Tickets").append(html);
                                    $('#layer_Person_' + v.TicketID + '_1').combobox({});
                                    $('#layer_Person_' + v.TicketID + '_2').combobox({});
                                    $('#layer_Person_' + v.TicketID + '_3').combobox({});
                                }
                                else if (TicketType == "年检自检") {
                                    var html = '<div class="form-group">'

                                        + '<label class="col-sm-3">'
                                        + '工单号：' + v.TicketID
                                        + '</label>'

                                        + '<label class="col-sm-2">'
                                        + '工单状态：' + v.State
                                        + '</label>'

                                        + '<label class="col-sm-3">'
                                        + '工作描述：' + v.TicketType
                                        + '</label>'

                                        + '<label class="col-sm-4">'
                                        + '当前处理人：' + v.DutyPerson
                                        + '</label>'

                                        + '</div>'

                                        + '<div class="form-group">'
                                        + '<div style="padding: 0 100px;">'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="1">异常关闭当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="2">异常关闭该工单，并按新人员重新生成当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<div class="form-inline" style="padding-left:  30px;">'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_1" class="sr-only">选择年检自检组长</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_1">'
                                        + '<option value="" selected="selected">选择年检自检组长</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_2" class="sr-only">选择年检自检组员</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_2">'
                                        + '<option value="" selected="selected">选择年检自检组员</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '</div>'

                                        + '</div>'

                                        + '</div>';

                                    $("#layer_Tickets").append(html);
                                    $('#layer_Person_' + v.TicketID + '_1').combobox({});
                                    $('#layer_Person_' + v.TicketID + '_2').combobox({});
                                }
                                else if (TicketType == "自检") {
                                    var html = '<div class="form-group">'

                                        + '<label class="col-sm-3">'
                                        + '工单号：' + v.TicketID
                                        + '</label>'

                                        + '<label class="col-sm-2">'
                                        + '工单状态：' + v.State
                                        + '</label>'

                                        + '<label class="col-sm-3">'
                                        + '工作描述：' + v.TicketType
                                        + '</label>'

                                        + '<label class="col-sm-4">'
                                        + '当前处理人：' + v.DutyPerson
                                        + '</label>'

                                        + '</div>'

                                        + '<div class="form-group">'
                                        + '<div style="padding: 0 100px;">'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="1">异常关闭当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="2">异常关闭该工单，并按新人员重新生成当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<div class="form-inline" style="padding-left:  30px;">'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_1" class="sr-only">选择自检组长</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_1">'
                                        + '<option value="" selected="selected">选择自检组长</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '<div class="form-group" style="margin: 0">'
                                        + '<label for="layer_Person_' + v.TicketID + '_2" class="sr-only">选择自检组员</label>'
                                        + '<select class="combobox form-control" id="layer_Person_' + v.TicketID + '_2">'
                                        + '<option value="" selected="selected">选择自检组员</option>'
                                        + '</select>'
                                        + '</div>'

                                        + '</div>'

                                        + '</div>'

                                        + '</div>';

                                    $("#layer_Tickets").append(html);
                                    $('#layer_Person_' + v.TicketID + '_1').combobox({});
                                    $('#layer_Person_' + v.TicketID + '_2').combobox({});
                                }
                                else if (TicketType == "检修" || TicketType == "大修整改") {
                                    var html = '<div class="form-group">'

                                        + '<label class="col-sm-3">'
                                        + '工单号：' + v.TicketID
                                        + '</label>'

                                        + '<label class="col-sm-2">'
                                        + '工单状态：' + v.State
                                        + '</label>'

                                        + '<label class="col-sm-3">'
                                        + '工作描述：' + v.TicketType
                                        + '</label>'

                                        + '<label class="col-sm-4">'
                                        + '当前处理人：' + v.DutyPerson
                                        + '</label>'

                                        + '</div>'

                                        + '<div class="form-group">'
                                        + '<div style="padding: 0 100px;">'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="1">异常关闭当前工单'
                                        + '</label>'
                                        + '<br/>'

                                        + '<label class="radio-inline i-checks">'
                                        + '<input type="radio" name="deal_' + v.TicketID + '" value="2">异常关闭该工单，并重新生成工单，分配给新小组'
                                        + '</label>'
                                        + '<br/>'

                                        + '</div>'

                                        + '</div>';

                                    $("#layer_Tickets").append(html);
                                }
                            });

                            $('.i-checks').iCheck({
                                checkboxClass: 'icheckbox_square-green',
                                radioClass: 'iradio_square-green',
                            });
                        }
                    } else {
                        app.error(res.msg);
                    }
                },
                callback_params: {}
            };
            app.execPostRequest(options);
        });

        function doNewTeamChange() {
            var Team = $("#layer_NewTeam").val();
            if (Team == "") {
                if (TicketType == "维保") {
                    $("#layer_Person1").html('<option value="" selected="selected">选择维保组员</option>');
                    $("#layer_Person1").combobox("refresh");
                    $("#layer_Person1").combobox("clearTarget");
                    $("#layer_Person1").combobox("clearElement");
                    $("#layer_Person2").html('<option value="" selected="selected">选择维保组员</option>');
                    $("#layer_Person2").combobox("refresh");
                    $("#layer_Person2").combobox("clearTarget");
                    $("#layer_Person2").combobox("clearElement");
                    $("#layer_Person3").html('<option value="" selected="selected">选择维保组员</option>');
                    $("#layer_Person3").combobox("refresh");
                    $("#layer_Person3").combobox("clearTarget");
                    $("#layer_Person3").combobox("clearElement");

                }
                else if (TicketType == "年检自检") {
                    $("#layer_Person1").html('<option value="" selected="selected">选择年检自检组长</option>');
                    $("#layer_Person1").combobox("refresh");
                    $("#layer_Person1").combobox("clearTarget");
                    $("#layer_Person1").combobox("clearElement");
                    $("#layer_Person2").html('<option value="" selected="selected">选择年检自检组员</option>');
                    $("#layer_Person2").combobox("refresh");
                    $("#layer_Person2").combobox("clearTarget");
                    $("#layer_Person2").combobox("clearElement");
                }

                if (TicketType == "维保" || TicketType == "年检自检" || TicketType == "自检") {
                    $("select[id^='layer_Person_']").each(function () {
                        var id = $(this).attr("id");
                        if (TicketType == "维保") {
                            $(this).html('<option value="" selected="selected">选择维保组员</option>');
                        } else if (TicketType == "年检自检") {
                            if ('1' == id.substr(id.length - 1)) {
                                $(this).html('<option value="" selected="selected">请选择年检自检组长</option>');
                            } else {
                                $(this).html('<option value="" selected="selected">请选择年检自检组员</option>');
                            }
                        } else {
                            if ('1' == id.substr(id.length - 1)) {
                                $(this).html('<option value="" selected="selected">请选择自检组长</option>');
                            } else {
                                $(this).html('<option value="" selected="selected">请选择自检组员</option>');
                            }
                        }

                        $("#" + id).combobox("refresh");
                        $("#" + id).combobox("clearTarget");
                        $("#" + id).combobox("clearElement");
                    });
                }

                return;
            }

            var options = {
                url: 'FindTeamWithKey',
                data: {
                    TeamName: Team,
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        if (res.data.Member && res.data.Member.length > 0) {
                            res.data.Member.forEach(function (v, i, a) {
                                var html = '<option value="' + v.UserName + '">' + v.PersonName + '</option>';
                                if (TicketType == "维保") {
                                    $("#layer_Person1").append(html);
                                    $("#layer_Person2").append(html);
                                    $("#layer_Person3").append(html);
                                } else if (TicketType == "年检自检") {
                                    $("#layer_Person1").append(html);
                                    $("#layer_Person2").append(html);
                                }

                                $("select[id^='layer_Person_']").each(function () {
                                    $(this).append(html);
                                });
                            })

                            if (TicketType == "维保") {
                                $("#layer_Person1").combobox("refresh");
                                $("#layer_Person1").combobox("clearTarget");
                                $("#layer_Person1").combobox("clearElement");

                                $("#layer_Person2").combobox("refresh");
                                $("#layer_Person2").combobox("clearTarget");
                                $("#layer_Person2").combobox("clearElement");

                                $("#layer_Person3").combobox("refresh");
                                $("#layer_Person3").combobox("clearTarget");
                                $("#layer_Person3").combobox("clearElement");
                            } else if (TicketType == "年检自检") {
                                $("#layer_Person1").combobox("refresh");
                                $("#layer_Person1").combobox("clearTarget");
                                $("#layer_Person1").combobox("clearElement");

                                $("#layer_Person2").combobox("refresh");
                                $("#layer_Person2").combobox("clearTarget");
                                $("#layer_Person2").combobox("clearElement");
                            }

                            $("select[id^='layer_Person_']").each(function () {
                                var id = $(this).attr("id");
                                $("#" + id).combobox("refresh");
                                $("#" + id).combobox("clearTarget");
                                $("#" + id).combobox("clearElement");
                            });
                        } else {
                            app.warning("该组还未分配组员！");
                            $("#layer_NewTeam").combobox("refresh");
                            $("#layer_NewTeam").combobox("clearTarget");
                            $("#layer_NewTeam").combobox("clearElement");
                        }
                    } else {
                        app.error(res.msg);
                        $("#layer_NewTeam").combobox("refresh");
                        $("#layer_NewTeam").combobox("clearTarget");
                        $("#layer_NewTeam").combobox("clearElement");
                    }
                },
                callback_params: {}
            };

            app.execPostRequest(options);
        }

        //工作交接
        function doWorkReplace() {
            swal({
                title: "警告",
                text: "确定进行工作交接？",
                type: "warning",
                showCancelButton: true,
                cancelButtonColor: 'white',
                cancelButtonText: '取消',
                confirmButtonColor: "#18a689",
                confirmButtonText: "确认",
                closeOnConfirm: true
            }, function () {
                var TeamName = $("#layer_NewTeam").val();
                if (TeamName == "") {
                    app.warning("请选择交接小组");
                    return;
                }
                if (TicketType == "维保") {
                    var ShouldDealMember1 = $("#layer_Person1").val();
                    var ShouldDealMember2 = $("#layer_Person2").val();
                    var ShouldDealMember3 = $("#layer_Person3").val();
                    if ((ShouldDealMember1 == "" || ShouldDealMember1 == null)
                        && (ShouldDealMember2 == "" || ShouldDealMember2 == null)
                        && (ShouldDealMember3 == "" || ShouldDealMember3 == null)) {
                        app.warning("请至少选择一个新维保人员");
                        return;
                    }

                    var DealList = [];
                    //处理每一个工单
                    TicketIDS.forEach(function (v, i, a) {
                        var IsUnusualClose = $("input[name='deal_" + v + "']:checked").val();
                        if (IsUnusualClose == null) {
                            app.warning("工单：" + v + ",还未选择交接方式！");
                            return;
                        }
                        var DealMember1 = "";
                        var DealMember2 = "";
                        var DealMember3 = "";
                        if (IsUnusualClose == 1) {
                            IsUnusualClose = true;
                        } else {
                            IsUnusualClose = false;
                            DealMember1 = $('#layer_Person_' + v + '_1').val();
                            DealMember2 = $('#layer_Person_' + v + '_2').val();
                            DealMember3 = $('#layer_Person_' + v + '_3').val();
                            if ((DealMember1 == "" || DealMember1 == null)
                                && (DealMember2 == "" || DealMember2 == null)
                                && (DealMember3 == "" || DealMember3 == null)) {
                                app.warning("工单：" + v + ",请至少选择一个维保人员");
                                return;
                            }
                        }
                        DealList.push({
                            TicketID: parseInt(v),
                            IsUnusualClose: IsUnusualClose,
                            DealMember1: DealMember1,
                            DealMember2: DealMember2,
                            DealMember3: DealMember3,
                        })
                    });

                    var options = {
                        url: 'ChangeMaintainTeamWithLotsTicket',
                        data: {
                            UserName: app.getLoginUserName(),
                            ElevatorNumList: list,
                            TeamName: TeamName,
                            ShouldDealMember1: ShouldDealMember1,
                            ShouldDealMember2: ShouldDealMember2,
                            ShouldDealMember3: ShouldDealMember3,
                            DealList: DealList,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                app.success("交接成功！", function () {
                                    localStorage.setItem("team", TeamName);
                                    localStorage.setItem("maintainMember1", ShouldDealMember1);
                                    localStorage.setItem("maintainMember2", ShouldDealMember2);
                                    localStorage.setItem("maintainMember3", ShouldDealMember3);
                                    parent.doWorkReplaceCallback(TicketType);
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                });
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                }

                else if (TicketType == "年检自检") {
                    var ShouldDealMember1 = $("#layer_Person1").val();
                    var ShouldDealMember2 = $("#layer_Person2").val();
                    if (ShouldDealMember1 == "" || ShouldDealMember1 == null) {
                        app.warning("新年检人员中请选择年检自检组长");
                        return;
                    }

                    var DealList = [];
                    //处理每一个工单
                    TicketIDS.forEach(function (v, i, a) {
                        var IsUnusualClose = $("input[name='deal_" + v + "']:checked").val();
                        if (IsUnusualClose == null) {
                            app.warning("工单：" + v + ",还未选择交接方式！");
                            return;
                        }
                        var DealMember1 = "";
                        var DealMember2 = "";
                        if (IsUnusualClose == 1) {
                            IsUnusualClose = true;
                        } else {
                            IsUnusualClose = false;
                            DealMember1 = $('#layer_Person_' + v + '_1').val();
                            DealMember2 = $('#layer_Person_' + v + '_2').val();
                            if (DealMember1 == "" || DealMember1 == null) {
                                app.warning("工单：" + v + ",请选择年检自检组长");
                                return;
                            }
                        }
                        DealList.push({
                            TicketID: parseInt(v),
                            IsUnusualClose: IsUnusualClose,
                            DealMember1: DealMember1,
                            DealMember2: DealMember2,
                        })
                    });

                    var options = {
                        url: 'ChangeYearTeamWithLotsTicket',
                        data: {
                            UserName: app.getLoginUserName(),
                            ElevatorNumList: list,
                            TeamName: TeamName,
                            ShouldDealMember1: ShouldDealMember1,
                            ShouldDealMember2: ShouldDealMember2,
                            DealList: DealList,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                app.success("交接成功！", function () {
                                    localStorage.setItem("team", TeamName);
                                    localStorage.setItem("yearMember1", ShouldDealMember1);
                                    localStorage.setItem("yearMember2", ShouldDealMember2);
                                    parent.doWorkReplaceCallback(TicketType);
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                });
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                }

                else if (TicketType == "自检") {
                    var DealList = [];
                    //处理每一个工单
                    TicketIDS.forEach(function (v, i, a) {
                        var IsUnusualClose = $("input[name='deal_" + v + "']:checked").val();
                        if (IsUnusualClose == null) {
                            app.warning("工单：" + v + ",还未选择交接方式！");
                            return;
                        }
                        var DealMember1 = "";
                        var DealMember2 = "";
                        if (IsUnusualClose == 1) {
                            IsUnusualClose = true;
                        } else {
                            IsUnusualClose = false;
                            DealMember1 = $('#layer_Person_' + v + '_1').val();
                            DealMember2 = $('#layer_Person_' + v + '_2').val();
                            if (DealMember1 == "" || DealMember1 == null) {
                                app.warning("工单：" + v + ",请选择自检组长");
                                return;
                            }
                        }
                        DealList.push({
                            TicketID: parseInt(v),
                            IsUnusualClose: IsUnusualClose,
                            DealMember1: DealMember1,
                            DealMember2: DealMember2,
                        })
                    });

                    var options = {
                        url: 'ChangeSelfTeamWithLotsTicket',
                        data: {
                            UserName: app.getLoginUserName(),
                            ElevatorNumList: list,
                            TeamName: TeamName,
                            DealList: DealList,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                app.success("交接成功！", function () {
                                    localStorage.setItem("team", TeamName);
                                    parent.doWorkReplaceCallback(TicketType);
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                });
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                }

                else if (TicketType == "检修") {
                    var DealList = [];
                    //处理每一个工单
                    TicketIDS.forEach(function (v, i, a) {
                        var IsUnusualClose = $("input[name='deal_" + v + "']:checked").val();
                        if (IsUnusualClose == null) {
                            app.warning("工单：" + v + ",还未选择交接方式！");
                            return;
                        }
                        var DealMember1 = "";
                        var DealMember2 = "";
                        if (IsUnusualClose == 1) {
                            IsUnusualClose = true;
                        } else {
                            IsUnusualClose = false;
                        }
                        DealList.push({
                            TicketID: parseInt(v),
                            IsUnusualClose: IsUnusualClose,
                        })
                    });

                    var options = {
                        url: 'ChangeCheckTeamWithLotsTicket',
                        data: {
                            UserName: app.getLoginUserName(),
                            ElevatorNumList: list,
                            TeamName: TeamName,
                            DealList: DealList,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                app.success("交接成功！", function () {
                                    localStorage.setItem("team", TeamName);
                                    parent.doWorkReplaceCallback(TicketType);
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                });
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                }

                else if (TicketType == "大修整改") {
                    var DealList = [];
                    //处理每一个工单
                    TicketIDS.forEach(function (v, i, a) {
                        var IsUnusualClose = $("input[name='deal_" + v + "']:checked").val();
                        if (IsUnusualClose == null) {
                            app.warning("工单：" + v + ",还未选择交接方式！");
                            return;
                        }
                        var DealMember1 = "";
                        var DealMember2 = "";
                        if (IsUnusualClose == 1) {
                            IsUnusualClose = true;
                        } else {
                            IsUnusualClose = false;
                        }
                        DealList.push({
                            TicketID: parseInt(v),
                            IsUnusualClose: IsUnusualClose,
                        })
                    });

                    var options = {
                        url: 'ChangeBigTeamWithLotsTicket',
                        data: {
                            UserName: app.getLoginUserName(),
                            ElevatorNumList: list,
                            TeamName: TeamName,
                            DealList: DealList,
                        },
                        callback: function (res, params) {
                            res = eval("(" + res + ")");
                            if (res.code == 10000) {
                                app.success("交接成功！", function () {
                                    localStorage.setItem("team", TeamName);
                                    parent.doWorkReplaceCallback(TicketType);
                                    var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                                    parent.layer.close(index); //再执行关闭
                                });
                            } else {
                                app.error(res.msg);
                            }
                        },
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                }
            });
        }
    </script>
</body>

</html>