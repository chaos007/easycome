<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>全局管理</title>
    <link href="../../res/admin/font-awesome/css/font-awesome.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap.min.css" rel="stylesheet">
    <link href="../../res/admin/css/bootstrap-combobox.css" rel="stylesheet">

    <link href="../../res/admin/css/plugins/jQueryUI/jquery-ui-1.10.4.custom.min.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/jqGrid/ui.jqgrid.css" rel="stylesheet">

    <!-- Toastr style -->
    <link href="../../res/admin/css/plugins/toastr/toastr.min.css" rel="stylesheet">

    <!-- Sweet Alert -->
    <link href="../../res/admin/css/plugins/sweetalert/sweetalert.css" rel="stylesheet">

    <link href="../../res/admin/css/animate.css" rel="stylesheet">
    <link href="../../res/admin/css/style.css" rel="stylesheet">

    <!-- iCheck -->
    <link href="../../res/admin/css/plugins/iCheck/custom.css" rel="stylesheet">
    <link href="../../res/admin/css/plugins/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" rel="stylesheet">

    <!-- Data picker -->
    <link href="../../res/admin/css/plugins/datapicker/datepicker3.css" rel="stylesheet">

</head>
<!-- <style type="text/css">
    .ui-jqgrid tr.jqgrow td {
        white-space: normal !important;
        height: auto;
        vertical-align: middle;
        padding-top: 10px;
        text-align:left;
    }
</style> -->

<body class="gray-bg">
    <div id="inner-wrapper">
        <div class="wrapper wrapper-content  animated fadeInRight" style="padding: 0; ">
            <div class="row">
                <div class="col-lg-12">
                    <div class="ibox " style="border: none;">
                        <div class="ibox-content ">
                            <div id="search-form" style="margin-bottom: 10px;">
                                <div class="form-inline">
                                    <div class="form-group" style="float: right;">
                                        <a class="btn btn-default" data-toggle="modal" href="global_import.html" data-target="#win">
                                            <i class="fa fa-file-excel-o"></i>&nbsp;导入</a>
                                        <a onclick="javascript:app.setWinUrl(this)" class="btn btn-default" data-toggle="modal" href="global_export.html" data-target="#win">
                                            <i class="fa fa-plus"></i>&nbsp;导出</a>
                                        <a onclick="doChangeElevators(this)" class="btn btn-default" data-toggle="modal" href="global_lots.html" data-target="#win"
                                            id="losts">
                                            <i class="fa fa-file-excel-o"></i>&nbsp;批量修改</a>
                                    </div>
                                </div>
                                <div class="form-inline">
                                    <div class="form-group">
                                        <label for="property" class="sr-only">物业名称</label>
                                        <select class="combobox form-control" id="property" onchange="doListPropertyChange()">
                                            <option value="" selected="selected">物业名称</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="building" class="sr-only">楼号名称</label>
                                        <select class="combobox form-control" id="building">
                                            <option value="" selected="selected">楼号名称</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="project" class="sr-only">项目</label>
                                        <select class="combobox form-control" id="project">
                                            <option value="" selected="selected">项目</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="elevator" class="sr-only">电梯编号</label>
                                        <input class="form-control" id="elevator" placeholder="电梯编号" />
                                    </div>
                                    <div class="form-group">
                                        <label for="task_group" class="sr-only">责任小组</label>
                                        <select class="combobox form-control" id="task_group">
                                            <option value="" selected="selected">责任小组</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="task_person" class="sr-only">责任人</label>
                                        <select class="combobox form-control" id="task_person">
                                            <option value="" selected="selected">责任人</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="maintain_project" class="sr-only">维保项目</label>
                                        <select class="combobox form-control" id="maintain_project">
                                            <option value="" selected="selected">维保项目</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="year_project" class="sr-only">年检项目</label>
                                        <select class="combobox form-control" id="year_project">
                                            <option value="" selected="selected">年检项目</option>
                                        </select>
                                    </div>

                                    <button class="btn btn-primary" onclick="getGlobalList()">查询</button>
                                </div>
                            </div>
                            <div class="jqGrid_wrapper">
                                <table id="table"></table>
                                <div id="pager"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal inmodal" id="win" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static">
        <div class="modal-dialog modal-lg" style="width: 90%;">
            <div class="modal-content animated fadeIn">

            </div>
        </div>
    </div>

    <script src="../../res/admin/js/jquery-2.1.1.js"></script>
    <script src="../../res/admin/js/bootstrap.min.js"></script>
    <script src="../../res/admin/js/bootstrap-combobox.js"></script>

    <!-- Toastr script -->
    <script src="../../res/admin/js/plugins/toastr/toastr.min.js"></script>

    <!-- Sweet alert -->
    <script src="../../res/admin/js/plugins/sweetalert/sweetalert.min.js"></script>

    <!-- jqGrid -->
    <script src="../../res/admin/js/plugins/jqGrid/i18n/grid.locale-en.js"></script>
    <script src="../../res/admin/js/plugins/jqGrid/jquery.jqGrid.min.js"></script>

    <!-- iCheck -->
    <script src="../../res/admin/js/plugins/iCheck/icheck.min.js"></script>

    <script src="https://cdn.bootcss.com/blueimp-md5/2.6.0/js/md5.js"></script>
    <script src="../../res/admin/js/app.js"></script>

    <!-- Data picker -->
    <script src="../../res/admin/js/plugins/datapicker/bootstrap-datepicker.js"></script>
    <script src="../../res/admin/js/plugins/datapicker/locales/bootstrap-datepicker.zh-CN.js"></script>

    <script src="../../res/js/layer/layer-min.js"></script>
    <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp"></script>
    <script>
        $(document).ready(function () {
            $("#location", window.parent.document).html("后台管理 >维保管理 >全局管理");

            app.initCombobox({
                url: 'GetPropertyName',
                callback_params: {
                    id: 'property',
                }
            });

            app.initCombobox({
                url: 'GetBuildingName',
                callback_params: {
                    id: 'building',
                }
            });

            app.initCombobox({
                url: 'GetProjectName',
                callback_params: {
                    id: 'project',
                }
            });

            app.initCombobox({
                url: 'GetDealMemberName',
                callback_params: {
                    id: 'task_person',
                }
            });

            app.initCombobox({
                url: 'GetDutyTeamName',
                callback_params: {
                    id: 'task_group',
                }
            });

            app.initCombobox({
                url: 'GetMaintainProjectInfo',
                data: {
                    BigType: "维保",
                    IsAbandon: "未弃用",
                },
                callback_params: {
                    id: 'maintain_project',
                }
            });

            app.initCombobox({
                url: 'GetMaintainProjectInfo',
                data: {
                    BigType: "自检",
                    IsAbandon: "未弃用",
                },
                callback_params: {
                    id: 'year_project',
                }
            });

            initGrid();
            getGlobalList();

            $("#win").on("hidden.bs.modal", function () {
                $(this).removeData("bs.modal");
            });
        });

        function doListPropertyChange() {
            var property = $("#property").val();
            $("#building").html('<option value="" selected="selected">楼号名称</option>');
            $("#project").html('<option value="" selected="selected">项目</option>');
            app.initCombobox({
                url: 'GetBuildingName',
                data: {
                    PropertyName: property,
                },
                callback_params: {
                    id: 'building',
                    refresh: true,
                }
            });

            app.initCombobox({
                url: 'GetProjectName',
                data: {
                    PropertyName: property,
                },
                callback_params: {
                    id: 'project',
                    refresh: true,
                }
            });
        }

        function getGlobalList() {
            var PropertyName = $("#property").val();
            var BuildingName = $("#building").val();
            var ProjectName = $("#project").val();
            var Elevator = $("#elevator").val();
            var BigTeam = $("#task_group").val();
            var MaintainTeam = $("#task_person").val();
            var MaintainProjectID = $("#maintain_project").val();
            var YearCheckProjectID = $("#year_project").val();

            var options = {
                url: 'GetAllElevatorManagerInfo',
                data: {
                    PropertyName: PropertyName,
                    ElevatorNum: Elevator,
                    BuildingName: BuildingName,
                    ManufacturerName: "",
                    ProjectName: ProjectName,
                    BigTeam: BigTeam,
                    MaintainTeam: MaintainTeam,
                    MaintainProjectID: parseInt(MaintainProjectID),
                    YearCheckProjectID: parseInt(YearCheckProjectID),
                },
                callback: setGlobalGrid,
                callback_params: {}
            };

            app.execPostRequest(options);
        }

        function setGlobalGrid(res, params) {
            res = eval("(" + res + ")");
            if (res.code == 10000) {
                var dataSource = [];
                if (res.data && res.data.length > 0) {
                    res.data.forEach(function (value, index, arr) {
                        var DutyTeam = "";
                        if (value.DutyTeams) {
                            value.DutyTeams.forEach(function (v, i, a) {
                                DutyTeam += v.TeamType + ":" + v.TeamName + "/";
                                if (v.TeamLear) {
                                    v.TeamLeader.forEach(function (vv, ii, aa) {
                                        DutyTeam += vv + "、";
                                    });
                                }
                                DutyTeam = DutyTeam.substring(0, DutyTeam.length - 1);
                                DutyTeam += "<br/>";
                            });
                        }


                        var Item = "";
                        if (value.MaintainProjectNames) {
                            value.MaintainProjectNames.forEach(function (v, i, a) {
                                Item += v + "<br/>";
                            });
                        }

                        var MaintainTeam = "";
                        if (value.MaintainTeamLeader && value.MaintainTeamLeader.Name) {
                            MaintainTeam = value.MaintainTeamLeader.Name;
                        }

                        if (value.MaintainTeamMember && value.MaintainTeamMember.Name.trim() != "") {
                            MaintainTeam += "、" + value.MaintainTeamMember.Name;
                        }

                        if (value.MaintainTeamMember2 && value.MaintainTeamMember2.Name.trim() != "") {
                            MaintainTeam += "、" + value.MaintainTeamMember2.Name;
                        }

                        if (MaintainTeam.substr(0, 1) == "、") {
                            MaintainTeam = MaintainTeam.substr(1);
                        }


                        var YearCheckTeam = "";
                        if (value.YearCheckTeamLeader && value.YearCheckTeamLeader.Name) {
                            YearCheckTeam = value.YearCheckTeamLeader.Name;
                        }

                        if (value.YearCheckTeamMember && value.YearCheckTeamMember.Name) {
                            YearCheckTeam += "、" + value.YearCheckTeamMember.Name;
                        }
                        if (YearCheckTeam.substr(0, 1) == "、") {
                            YearCheckTeam = YearCheckTeam.substr(1);
                        }

                        dataSource.push({
                            my_id: value.ElevatorNum,
                            id: value.ElevatorNum,
                            PropertyName: value.PropertyName,
                            BuildingName: value.BuildingName,
                            ProjectName: {
                                Name: value.ProjectName,
                                Start: value.ContractStartTime,
                                End: value.ContractEndTime,
                            },
                            DutyTeam: DutyTeam,
                            MaintainTeam: MaintainTeam,
                            MaintainItem: Item,
                            YearCheckTeam: YearCheckTeam,
                            YearCheckItem: value.YearCheckName,
                            Opts: value.ElevatorNum,
                        });
                    });
                }

                $("#table").jqGrid('clearGridData');  //清空表格
                $("#table").jqGrid('setGridParam', {  // 重新加载数据
                    datatype: 'local',
                    data: dataSource,
                    page: 1
                }).trigger("reloadGrid");
            } else {
                app.error(res.msg);
            }
        }

        function initGrid() {
            $("#table").jqGrid({
                colNames: ['', '电梯编号/信息', '物业信息', '楼号信息', '合同信息', '维保项目', '责任所属', '维保人员', '年检项目', '年检人员', '操作'],
                colModel: [
                    {
                        name: 'my_id',
                        index: 'my_id',
                        sortable: false,
                        hidden: true,
                        fixed: true,
                        align: "left",
                    },
                    {
                        name: 'id',
                        formatter: function (value, options, rowObject) {
                            if (value && value.trim() != "") {
                                var url = "../doc/elevator_tip.html?key=" + encodeURIComponent(value);
                                return value + "&nbsp;<a style='color:#134da5;' href='" + url + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;详情</a>";
                            } else {
                                return "";
                            }
                        }
                    },
                    {
                        name: 'PropertyName',
                        formatter: function (value, options, rowObject) {
                            if (value && value.trim() != "") {
                                var url = "../doc/basic/property_tip.html?key=" + encodeURIComponent(value);
                                return value + "&nbsp;<a style='color:#134da5;' href='" + url + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;详情</a>";
                            } else {
                                return "";
                            }
                        }
                    },
                    {
                        name: 'BuildingName',
                        formatter: function (value, options, rowObject) {
                            if (value && value.trim() != "") {
                                var url = "../doc/basic/building_tip.html?key=" + encodeURIComponent(value);
                                return value + "&nbsp;<a style='color:#134da5;' href='" + url + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;详情</a>";
                            } else {
                                return "";
                            }
                        }
                    },
                    {
                        name: 'ProjectName',
                        formatter: function (value, options, rowObject) {
                            if (value.Name && value.Name.trim() != "") {
                                var url = "../doc/basic/project_tip.html?key=" + encodeURIComponent(value.Name);
                                // var start = app.formatDateFromUnix(value.Start);
                                // var end = app.formatDateFromUnix(value.End);
                                return value.Name + "&nbsp;"
                                    + "<a style='color:#134da5;' href='" + url + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-info'></i>&nbsp;详情</a>";
                            } else {
                                return "";
                            }
                        }
                    },
                    { name: 'MaintainItem' },
                    { name: 'DutyTeam' },
                    { name: 'MaintainTeam' },
                    { name: 'YearCheckItem' },
                    { name: 'YearCheckTeam' },
                    {
                        name: 'Opts',
                        sortable: false,
                        width: "100px",
                        fixed: true,
                        formatter: function (value, options, rowObject) {
                            var url = "global_info.html?key=" + encodeURIComponent(value);
                            return "<a style='color:#134da5;' href='" + url + "' onclick='javascript:app.setWinUrl(this)' data-toggle='modal' data-target='#win'><i class='fa fa-edit'></i>&nbsp;责任分配</a>";
                        }
                    }
                ],
                rowNum: 10,
                rowList: app.rowList,
                data: [],
                datatype: "local",
                viewrecords: true,
                pager: "#pager",
                height: 'auto',
                multiselect: true,//复选框 
                multiselectWidth: 40,
                autowidth: true,
                shrinkToFit: true,
                forceFit: true,
                altRows: true,
                altclass: 'table-alt',
            });

            // Add responsive to jqGrid
            app.fitGrid();
            $(window).bind('resize', function () {
                app.fitGrid();
            });
        }

        function global_refresh(key, action) {
            var options = {
                url: 'GetAllElevatorManagerInfoWityKey',
                data: {
                    ElevatorNum: key,
                },
                callback: function (res, params) {
                    res = eval("(" + res + ")");
                    if (res.code == 10000) {
                        var DutyTeam = "";
                        if (res.data.DutyTeams) {
                            res.data.DutyTeams.forEach(function (v, i, a) {
                                DutyTeam += v.TeamType + "/" + v.TeamName + "/";
                                if (v.TeamLear) {
                                    v.TeamLeader.forEach(function (vv, ii, aa) {
                                        DutyTeam += vv + "、";
                                    });
                                }
                                DutyTeam = DutyTeam.substring(0, DutyTeam.length - 1);
                                DutyTeam += "<br/>";
                            });
                        }


                        var Item = "";
                        if (res.data.MaintainItems) {
                            res.data.MaintainItems.forEach(function (v, i, a) {
                                Item += v.Name + "<br/>";
                            });
                        }

                        var MaintainTeam = "";
                        if (res.data.MaintainTeamLeader && res.data.MaintainTeamLeader.Name) {
                            MaintainTeam = res.data.MaintainTeamLeader.Name;
                        }

                        if (res.data.MaintainTeamMember && res.data.MaintainTeamMember.Name.trim() != "") {
                            MaintainTeam += "、" + res.data.MaintainTeamMember.Name;
                        }

                        if (res.data.MaintainTeamMember2 && res.data.MaintainTeamMember2.Name.trim() != "") {
                            MaintainTeam += "、" + res.data.MaintainTeamMember2.Name;
                        }

                        if (MaintainTeam.substr(0, 1) == "、") {
                            MaintainTeam = MaintainTeam.substr(1);
                        }


                        var YearCheckTeam = "";
                        if (res.data.YearCheckTeamLeader && res.data.YearCheckTeamLeader.Name) {
                            YearCheckTeam = res.data.YearCheckTeamLeader.Name;
                        }

                        if (res.data.YearCheckTeamMember && res.data.YearCheckTeamMember.Name) {
                            YearCheckTeam += "、" + res.data.YearCheckTeamMember.Name;
                        }
                        if (YearCheckTeam.substr(0, 1) == "、") {
                            YearCheckTeam = YearCheckTeam.substr(1);
                        }

                        var recode = {
                            my_id: res.data.ElevatorNum,
                            id: res.data.ElevatorNum,
                            PropertyName: res.data.PropertyName,
                            BuildingName: res.data.BuildingName,
                            ProjectName: {
                                Name: res.data.ProjectName,
                                Start: res.data.ContractStartTime,
                                End: res.data.ContractEndTime,
                            },
                            DutyTeam: DutyTeam,
                            MaintainTeam: MaintainTeam,
                            MaintainItem: Item,
                            YearCheckTeam: YearCheckTeam,
                            YearCheckItem: res.data.YearCheckName,
                            Opts: res.data.ElevatorNum,
                        };

                        if (action == "add") {
                            $("#table").jqGrid("addRowData", recode.id, recode, "first");
                        } else {
                            $('#table').setRowData(recode.id, recode, '');
                        }
                    }
                },
                callback_params: {}
            };

            app.execPostRequest(options);
        }

        function global_list_refresh(list) {
            if (list.length <= 0) {
                return;
            }
            list.forEach(function (key, i, a) {
                var options = {
                    url: 'GetAllElevatorManagerInfoWityKey',
                    data: {
                        ElevatorNum: key,
                    },
                    callback: function (res, params) {
                        res = eval("(" + res + ")");
                        if (res.code == 10000) {
                            var DutyTeam = "";
                            if (res.data.DutyTeams) {
                                res.data.DutyTeams.forEach(function (v, i, a) {
                                    DutyTeam += v.TeamType + "/" + v.TeamName + "/";
                                    if (v.TeamLear) {
                                        v.TeamLeader.forEach(function (vv, ii, aa) {
                                            DutyTeam += vv + "、";
                                        });
                                    }
                                    DutyTeam = DutyTeam.substring(0, DutyTeam.length - 1);
                                    DutyTeam += "<br/>";
                                });
                            }


                            var Item = "";
                            if (res.data.MaintainItems) {
                                res.data.MaintainItems.forEach(function (v, i, a) {
                                    Item += v.Name + "<br/>";
                                });
                            }

                            var MaintainTeam = "";
                            if (res.data.MaintainTeamLeader && res.data.MaintainTeamLeader.Name) {
                                MaintainTeam = res.data.MaintainTeamLeader.Name;
                            }

                            if (res.data.MaintainTeamMember && res.data.MaintainTeamMember.Name.trim() != "") {
                                MaintainTeam += "、" + res.data.MaintainTeamMember.Name;
                            }

                            if (res.data.MaintainTeamMember2 && res.data.MaintainTeamMember2.Name.trim() != "") {
                                MaintainTeam += "、" + res.data.MaintainTeamMember2.Name;
                            }

                            if (MaintainTeam.substr(0, 1) == "、") {
                                MaintainTeam = MaintainTeam.substr(1);
                            }


                            var YearCheckTeam = "";
                            if (res.data.YearCheckTeamLeader && res.data.YearCheckTeamLeader.Name) {
                                YearCheckTeam = res.data.YearCheckTeamLeader.Name;
                            }

                            if (res.data.YearCheckTeamMember && res.data.YearCheckTeamMember.Name) {
                                YearCheckTeam += "、" + res.data.YearCheckTeamMember.Name;
                            }
                            if (YearCheckTeam.substr(0, 1) == "、") {
                                YearCheckTeam = YearCheckTeam.substr(1);
                            }

                            var recode = {
                                my_id: res.data.ElevatorNum,
                                id: res.data.ElevatorNum,
                                PropertyName: res.data.PropertyName,
                                BuildingName: res.data.BuildingName,
                                ProjectName: {
                                    Name: res.data.ProjectName,
                                    Start: res.data.ContractStartTime,
                                    End: res.data.ContractEndTime,
                                },
                                DutyTeam: DutyTeam,
                                MaintainTeam: MaintainTeam,
                                MaintainItem: Item,
                                YearCheckTeam: YearCheckTeam,
                                YearCheckItem: res.data.YearCheckName,
                                Opts: res.data.ElevatorNum,
                            };
                            $('#table').setRowData(recode.id, recode, '');
                            
                        }
                    },
                    callback_params: {}
                };

                app.execPostRequest(options);
            })

        }

        function templateDownload() {
            var options = {
                url: 'ElevatorManager.xlsx',
                filename: '全局管理模板.xlsx',
            };
            app.templateFileDownload(options);
        }

        function doChangeElevators(obj) {
            var rowData = jQuery('#table').jqGrid('getGridParam', 'selarrrow');
            if (rowData.length) {
                var nameList = [];
                for (var i = 0; i < rowData.length; i++) {
                    var name = jQuery('#table').jqGrid('getCell', rowData[i], 'my_id');//name是colModel中的一属性
                    nameList.push(name);
                }
                localStorage.setItem("list", nameList);

            } else {
                app.warning("请选择电梯");
                return
            }
        }
    </script>
</body>

</html>