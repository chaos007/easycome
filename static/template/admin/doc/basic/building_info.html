<div class="modal-header" style="padding: 15px">
    <button type="button" class="close" data-dismiss="modal">
        <span aria-hidden="true" style="font-size: 30px;">&times;</span>
        <span class="sr-only">Close</span>
    </button>
    <h6 class="modal-title">新增楼号</h6>
</div>
<div class="modal-body">
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox">
                <div class="ibox-title">
                    <h5>楼号信息</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-horizontal">
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                <span class="input-required">*</span>楼号名称
                            </label>

                            <div class="col-sm-10">
                                <input type="text" id="w_building" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">
                                <span class="input-required">*</span>所属物业
                            </label>

                            <div class="col-sm-10">
                                <div class="form-inline">
                                    <div class="form-group" style="margin:0;">
                                        <label for="w_property" class="sr-only">所属物业</label>
                                        <select class="combobox form-control" id="w_property" onchange="doPropertyChange()">
                                            <option value="" selected="selected">所属物业</option>
                                        </select>
                                    </div>
                                    &nbsp;找不到物业？
                                    <a onclick="app.openRightFrameFromWin('property.html')">物业管理</a>
                                </div>
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="col-sm-2 control-label">地址</label>
                            <div class="col-sm-10">
                                <input type="text" id="w_address" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">性质</label>

                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="w_occasion">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">纬度</label>

                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="w_lat">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">经度</label>

                            <div class="col-sm-10">
                                <input type="text" class="form-control" id="w_lng">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">地图搜索</label>

                            <label class="col-sm-1 control-label">名字</label>
                            <div class="col-sm-3">
                                <input type="text" class="form-control" id="w_search_name">
                            </div>
                            <label class="col-sm-1 control-label">城市</label>

                            <div class="col-sm-3">
                                <input type="text" class="form-control" id="w_search_city" value="厦门">
                            </div>
                            <button class="btn btn-primary" onclick="searchKeyword()">搜索</button>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">地图</label>
                            <div class="col-sm-8" id="map_canvas" style="min-width:603px; min-height:767px;"></div>
                        </div>
                    </div>
                </div>
                <div class="ibox-title">
                    <h5>联系人</h5>
                </div>
                <div class="ibox-content">
                    <div class="form-inline" style="margin-bottom: 10px;">
                        <div class="form-group">
                            <label for="w_property_person" class="sr-only">选择物业人员</label>
                            <select class="combobox form-control" id="w_property_person">
                                <option value="" selected="selected">选择物业人员</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="doAddContactsMember()">新增联系人</button>
                        &nbsp;找不到人员？
                        <a onclick="app.openRightFrameFromWin('../../staff/person.html')">物业人员</a>
                    </div>

                    <div class="ibox">
                        <div class="ibox-title" style="padding-left: 0;">
                            <h5>已有联系人</h5>
                        </div>
                        <div class="ibox-content">
                            <div class="dd" id="nestable">
                                <ol class="dd-list">
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-white" data-dismiss="modal">返回</button>
    <button type="button" class="btn btn-primary" onclick="saveBuildingInfo()">确认</button>
</div>
<script>
    var building_members = [];
    var building_property = "";
    var searchService, map, markers = [];
    $(function () {
        app.win_action = 'add';
        if (app.win_url.indexOf("?key=") > 0) {
            app.win_action = 'edit';
            app.win_key = decodeURIComponent(app.win_url.split("?key=")[1]);
        }

        if (app.win_action == 'edit') {
            //编辑页面
            $(".modal-title").html("编辑楼号")
            //获取info
            var options = {
                url: 'FindBuildingWithKey',
                data: {
                    BuildingName: app.win_key,
                },
                callback: initBuildingInfo,
                callback_params: {}
            };

            app.execPostRequest(options);

        } else {
            app.initCombobox({
                url: 'GetPropertyName',
                callback_params: {
                    id: 'w_property',
                    value: app.win_url.split("?property=")[1],
                }
            });

            $("#w_property_person").combobox();
            var result = app.initMap({
                ID: "map_canvas",
                Latitude: 24.46,
                Longitude: 118.10,
                IsInit: true,
            });
            markers = result.Markers;
            searchService = result.SearchService;
            map = result.Map;
        }
    });

    function initBuildingInfo(res, param) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            if (res.data == null) {
                return;
            }
            var info = res.data;
            $("#w_building").val(info.BuildingName);
            $("#w_building").attr("disabled", "disabled");

            building_property = info.PropertyName;
            app.initCombobox({
                url: 'GetPropertyName',
                callback_params: {
                    id: 'w_property',
                    value: info.PropertyName
                }
            });

            //根据物业初始化物业人员
            app.initCombobox({
                url: 'FindPropertyPerson',
                data: {
                    PropertyName: info.PropertyName,
                    SearchName: "",
                },
                callback_params: {
                    id: 'w_property_person',
                }
            });

            $("#w_address").val(info.Address);
            $("#w_occasion").val(info.Occasion);
            $("#w_lat").val(info.Latitude / 1000000);
            $("#w_lng").val(info.Longitude / 1000000);

            var result;
            if (info.Latitude == 0 && info.Longitude == 0) {
                result = app.initMap({
                    ID: "map_canvas",
                    Latitude: 24.46,
                    Longitude: 118.10,
                    IsInit: true,

                });
            } else {
                result = app.initMap({
                    ID: "map_canvas",
                    Latitude: info.Latitude / 1000000,
                    Longitude: info.Longitude / 1000000,
                    IsInit: false,
                });
            }
            markers = result.Markers;
            searchService = result.SearchService;
            map = result.Map;
            var contacts_list = res.data.ContactsName;
            if (contacts_list != null && contacts_list.length > 0) {
                contacts_list.forEach(function (value, index, arr) {
                    var options = {
                        url: 'FindPersonWithKey',
                        data: {
                            UserName: value.UserName,
                            IsProperty: true,
                        },
                        callback: addContactsLi,
                        callback_params: {}
                    };

                    app.execPostRequest(options);
                });
            }
        }
    }

    function saveBuildingInfo() {
        var building = $("#w_building").val();
        var property = $("#w_property").val();
        var address = $("#w_address").val();
        var occasion = $("#w_occasion").val();
        var latitude = $("#w_lat").val();
        var longitude = $("#w_lng").val();

        if (building.trim() == "") {
            app.warning("请输入楼号名称");
            return;
        }

        if (property.trim() == "") {
            app.warning("请选择所属物业");
            return;
        }

        if (parseFloat(latitude.trim()).toString() == "NaN") {
            app.warning("请输入正确的纬度");
            return;
        }

        if (parseFloat(longitude.trim()).toString() == "NaN") {
            app.warning("请输入正确的纬度");
            return;
        }
        longitudeInt = parseInt(parseFloat(longitude.trim()) * 1000000);
        latitudeInt = parseInt(parseFloat(latitude.trim()) * 1000000);

        if (app.win_action == 'add') {
            var options = {
                url: 'AddNewBuilding',
                data: {
                    BuildingName: building.trim(),
                    PropertyName: property.trim(),
                    Address: address.trim(),
                    Occasion: occasion.trim(),
                    Longitude: longitudeInt,
                    Latitude: latitudeInt,
                    ContactsName: building_members,
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "add",
                    refresh: building_refresh,
                    key: building.trim(),
                }
            };

            app.execPostRequest(options);
        } else {
            var options = {
                url: 'ChangeBuildingInfo',
                data: {
                    Name: building.trim(),
                    PropertyName: property.trim(),
                    Address: address.trim(),
                    Occasion: occasion.trim(),
                    Longitude: longitudeInt,
                    Latitude: latitudeInt,
                },
                callback: app.saveCallbackWindow,
                callback_params: {
                    action: "edit",
                    refresh: building_refresh,
                    key: building,
                }
            };

            app.execPostRequest(options);
        }
    }

    function addContactsLi(res, params) {
        res = eval("(" + res + ")");
        if (res.code == 10000) {
            var info = res.data;
            var html = '<li class="dd-item" data-value="' + info.UserName + '">'
                + '<div class="dd-handle">'
                + '<a style="color: #ed5565;"  href="javascript:;" onclick="doRemoveContactsMember(this)">删除</a>'
                + '&nbsp;&nbsp;<i class="fa fa-user"></i>&nbsp;姓名：' + info.Name
                + '&nbsp;&nbsp;角色：' + info.Role
                + '&nbsp;&nbsp;联系电话:' + info.Phone
                + '&nbsp;&nbsp;所属物业:' + info.PropertyCompany
                + '</div>'
                + '</li>';
            $(".dd-list").append(html);
        }
    }

    function doRemoveContactsMember(obj) {
        app.delete(function () {
            var li = $(obj).parents("li");
            var value = $(li).data("value");
            if (app.win_action == "add") {
                building_members.splice(jQuery.inArray(value, building_members), 1);
                $(li).remove();
            } else {
                var options = {
                    url: 'DelBuildingContact',
                    data: {
                        BuildingName: app.win_key,
                        UserName: value,
                    },
                    callback: function (res, params) {
                        res = eval("(" + res + ")");
                        if (res.code == 10000) {
                            $(params.li).remove();
                        } else {
                            app.error(res.msg);
                        }
                    },
                    callback_params: {
                        li: li,
                    }
                };
                app.execPostRequest(options);
            }
        });
    }

    function doAddContactsMember() {
        var building = $("#w_building").val();
        if (building.trim() == "") {
            app.info("请输入楼号名称");
            return;
        }

        var property = $("#w_property").val();
        if (property.trim() == "") {
            app.info("请选择所属物业");
            return;
        }

        var user_name = $("#w_property_person").val();
        if (user_name == "") {
            app.info("请选择物业人员");
            return;
        }

        var flag = false;
        $(".dd-item").each(function () {
            if (user_name == $(this).data("value")) {
                flag = true;
            }
        });
        if (flag) {
            app.error("已经添加过该联系人");
            return;
        }

        //获取info
        var options = {
            url: 'FindPersonWithKey',
            data: {
                UserName: user_name,
                IsProperty: true,
            },
            callback: function (res, params) {
                res = eval("(" + res + ")");
                if (res.code == 10000) {
                    //人员存在，保存为联系人

                    if (app.win_action == "add") {
                        building_members.push(user_name);
                        addContactsLi(JSON.stringify(res), {});
                    } else {
                        var options = {
                            url: 'AddBuildingContact',
                            data: {
                                BuildingName: building,
                                UserName: params.user_name,
                            },
                            callback: function (res, params) {
                                res = eval("(" + res + ")");
                                if (res.code == 10000) {
                                    addContactsLi(JSON.stringify(params.res), {});
                                } else {
                                    app.error(res.msg);
                                }
                            },
                            callback_params: {
                                res: res,
                            }
                        };
                        app.execPostRequest(options);
                    }
                } else {
                    app.error(res.msg);
                }
            },
            callback_params: {
                user_name: user_name,
            }
        };

        app.execPostRequest(options);
    }

    function doPropertyChange() {
        var property = $("#w_property").val();
        if (property == building_property) {
            return;
        }
        //删除楼号的物业联系人才能切换物业
        if ($(".dd-list").find("li") && $(".dd-list").find("li").length > 0) {
            app.warning("请先删除所属物业为" + building_property + "的楼号联系人，才能更换物业！");
            $("#w_property").html('<option value="" selected="selected">所属物业</option>');
            app.initCombobox({
                url: 'GetPropertyName',
                callback_params: {
                    id: 'w_property',
                    value: building_property,
                    refresh: true,
                }
            });
            return;
        }
        building_property = property;

        $("#w_property_person").html('<option value="" selected="selected">选择物业人员</option>');
        //根据物业初始化物业人员
        if (property == "") {
            $("#w_property_person").combobox("refresh");
        } else {
            app.initCombobox({
                url: 'FindPropertyPerson',
                data: {
                    PropertyName: property,
                    SearchName: "",
                },
                callback_params: {
                    id: 'w_property_person',
                    refresh: true,
                }
            });
        }
    }

    function searchKeyword() {
        var keyword = document.getElementById("w_search_name").value;
        var region = document.getElementById("w_search_city").value;
        if (keyword.trim() == "") {
            app.warning("请输入搜索名字");
            return
        }
        if (region.trim() == "") {
            app.warning("请输入城市");
            return
        }
        app.clearOverlays(markers);
        searchService.setLocation(region);
        searchService.search(keyword);
    }
</script>